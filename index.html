<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Stok Pintar - Inventory System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- LIBRARY SCANNER BARCODE ASLI -->
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  
  <!-- LIBRARY ICON -->
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <style>
    /* Custom Scrollbar hide */
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    /* Animasi Scanner */
    .scan-region-highlight { border-radius: 20px !important; border: 4px solid #3b82f6 !important; }
  </style>
</head>
<body class="bg-slate-100 touch-manipulation">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // --- UTILS: NORMALISASI FORMAT TANGGAL ---
    // Fungsi ini penting agar "1/2029", "01/2029", dan "01/2029 " dianggap sama
    const normalizeExpiry = (dateStr) => {
        if (!dateStr || dateStr === '-') return '-';
        // Hapus spasi
        let clean = String(dateStr).trim();
        // Jika format MM/YYYY, pastikan MM dua digit
        if (clean.includes('/')) {
            const parts = clean.split('/');
            if (parts.length === 2) {
                const m = parts[0].padStart(2, '0');
                const y = parts[1];
                return `${m}/${y}`;
            }
        }
        return clean;
    };

    // --- CONVERTER LUCIDE ICON KE REACT ---
    const lucideReact = Object.keys(lucide.icons).reduce((acc, iconName) => {
      acc[iconName] = ({ color = "currentColor", size = 24, className, strokeWidth = 2, ...props }) => {
        return React.createElement(
          'svg',
          {
            xmlns: "http://www.w3.org/2000/svg",
            width: size,
            height: size,
            viewBox: "0 0 24 24",
            fill: "none",
            stroke: color,
            strokeWidth: strokeWidth,
            strokeLinecap: "round",
            strokeLinejoin: "round",
            className: className,
            ...props
          },
          ...lucide.icons[iconName].map((child, index) => {
             const [tag, attrs] = child;
             return React.createElement(tag, { ...attrs, key: index });
          })
        );
      };
      return acc;
    }, {});

    const { 
      Scan, Package, Plus, Minus, Save, History, Search, ArrowLeft, X,
      Camera, PlusCircle, PenTool, Clock, ArrowUpRight, ArrowDownLeft,
      Settings, CheckCircle, Store, Calendar, Filter, Smartphone, Wifi,
      RefreshCw, AlertCircle, Loader2, Database, AlertTriangle, Edit3, ChevronDown
    } = lucideReact;

    /* --- KONFIGURASI UTAMA --- */
    // GANTI URL INI DENGAN DEPLOYMENT TERBARU ANDA
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxQrGCb1G-MDSTtlal365bRQRnxDoXMcXlgmkO7dc-_PyMnHy-y6qeRywsbTsmazgUm/exec";
    const STORE_CODE = "GUDANG UTAMA";

    /* --- DATA DEMO --- */
    const DEMO_INVENTORY = {
      "8992761136014": { id: "8992761136014", name: "Indomie Goreng", stock: 50, expiryDate: "12/2025", updatedAt: new Date().toISOString() },
    };
    const DEMO_LOGS = [];

    function App() {
      const [view, setView] = useState('home');
      const [inventory, setInventory] = useState({});
      const [logs, setLogs] = useState([]);
      const [currentProduct, setCurrentProduct] = useState(null);
      const [scannedCode, setScannedCode] = useState('');
      
      const [loading, setLoading] = useState(true);
      const [processing, setProcessing] = useState(false);
      const [errorMsg, setErrorMsg] = useState('');
      const [isDemoMode, setIsDemoMode] = useState(false);

      // --- FETCH DATA ---
      const fetchData = async () => {
        setLoading(true);
        setErrorMsg('');
        setIsDemoMode(false);
        try {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000); 

          const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=read&store=${encodeURIComponent(STORE_CODE)}`, { signal: controller.signal });
          clearTimeout(timeoutId);

          if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
          const data = await response.json();
          if (data.status === 'error') throw new Error(data.message);

          const invMap = {};
          if (data.inventory) {
            data.inventory.forEach(item => { invMap[item.id] = item; });
          }

          setInventory(invMap);
          setLogs(data.logs || []);
          setLoading(false);

        } catch (err) {
          console.warn("Offline Mode:", err);
          setInventory(DEMO_INVENTORY);
          setLogs(DEMO_LOGS);
          setIsDemoMode(true);
          setErrorMsg("Mode Offline / Demo");
          setLoading(false);
        }
      };

      useEffect(() => { fetchData(); }, []);

      // --- LOGIC UTAMA ---
      const handleScanSuccess = (code) => {
        setScannedCode(code);
        const existingProduct = inventory[code];
        if (existingProduct) {
          setCurrentProduct({ ...existingProduct, isNew: false, isManualInput: false });
        } else {
          setCurrentProduct({ id: code, name: '', stock: 0, isNew: true, isManualInput: false, expiryDate: '' });
        }
        setView('product');
      };

      const handleManualAdd = () => {
         setCurrentProduct({ id: '', name: '', stock: 0, isNew: true, isManualInput: true, expiryDate: '' });
         setView('product');
      };

      const saveProductTransaction = async (finalId, amount, type, expiryDate, finalName) => {
        setProcessing(true);

        const numAmount = parseInt(amount);
        const normExpiry = normalizeExpiry(expiryDate);
        
        const payload = {
          action: 'transaction',
          store: STORE_CODE,
          id: finalId,
          name: finalName,
          amount: numAmount,
          type: type,
          expiryDate: normExpiry,
          timestamp: new Date().toISOString()
        };

        try {
          await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors', 
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          // Optimistic Update
          const newInventory = { ...inventory };
          const oldStock = (newInventory[finalId] && newInventory[finalId].stock) ? newInventory[finalId].stock : 0;
          
          let finalStock = oldStock;
          if (type === 'new') finalStock = numAmount;
          else if (type === 'in') finalStock += numAmount;
          else if (type === 'out') finalStock -= numAmount;

          newInventory[finalId] = {
            id: finalId,
            name: finalName,
            stock: finalStock,
            expiryDate: normExpiry, // Update dengan format normal
            updatedAt: new Date().toISOString()
          };

          setInventory(newInventory);
          
          const newLog = {
            id: `local-${Date.now()}`,
            productId: finalId,
            productName: finalName,
            type: type,
            amount: numAmount,
            expiryDate: normExpiry,
            timestamp: new Date().toISOString() 
          };
          setLogs(prevLogs => [newLog, ...prevLogs]);

          setProcessing(false);
          setView('home');
          setScannedCode('');
          setCurrentProduct(null);
          
          if (isDemoMode) alert("Data disimpan lokal (Demo).");

        } catch (error) {
          console.error("Save Error:", error);
          alert("Gagal menyimpan data.");
          setProcessing(false);
        }
      };

      // --- RENDER UTAMA ---
      if (loading && !Object.keys(inventory).length) {
        return (
          <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center text-slate-500 font-sans">
            <Loader2 className="animate-spin h-10 w-10 text-blue-600 mb-4" />
            <p>Memuat Sistem...</p>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-slate-100 font-sans text-slate-800 max-w-md mx-auto shadow-2xl overflow-hidden relative flex flex-col">
          
          {/* HEADER */}
          <header className={`${isDemoMode ? 'bg-orange-600' : 'bg-blue-600'} text-white p-4 shadow-md sticky top-0 z-20`}>
            <div className="flex justify-between items-center">
              <div className="flex flex-col">
                <h1 className="text-lg font-bold flex items-center gap-2">
                  <Package size={20} /> Stok Pintar
                </h1>
                <span className="text-[10px] opacity-90 font-mono flex items-center gap-1 bg-black/20 px-2 py-0.5 rounded-full w-fit mt-1 border border-white/20">
                  <Store size={10} /> {STORE_CODE} {isDemoMode ? '(OFFLINE)' : '(ONLINE)'}
                </span>
              </div>
              <div className="flex items-center gap-3">
                <button onClick={fetchData} disabled={loading} className={`p-2 rounded-full hover:bg-white/20 ${loading ? 'animate-spin' : ''}`}>
                  <RefreshCw size={18} />
                </button>
                {view !== 'home' && (
                  <button onClick={() => setView('home')} className="text-blue-100 hover:text-white">
                    <X size={24} />
                  </button>
                )}
              </div>
            </div>
          </header>

          {processing && (
            <div className="absolute inset-0 z-50 bg-black/50 backdrop-blur-sm flex flex-col items-center justify-center text-white">
              <Loader2 className="animate-spin h-12 w-12 mb-2" />
              <p className="font-bold">Menyimpan Data...</p>
            </div>
          )}

          {errorMsg && (
            <div className="bg-orange-50 text-orange-700 px-4 py-3 text-xs flex items-start gap-2 border-b border-orange-100">
              <AlertCircle size={16} className="shrink-0 mt-0.5" />
              <div>
                <p className="font-bold mb-1">Mode Offline</p>
                <p>Data yang ditampilkan adalah data lokal/cache.</p>
              </div>
            </div>
          )}

          <main className="flex-1 overflow-y-auto p-4 pb-24 bg-slate-50 scroll-smooth">
            {view === 'home' && (
              <HomeView 
                inventory={inventory} 
                onSearch={(code) => code && handleScanSuccess(code)}
                scannedCode={scannedCode}
                setScannedCode={setScannedCode}
                onItemClick={(item) => { setCurrentProduct({ ...item, isNew: false }); setView('product'); }}
                loading={loading}
              />
            )}

            {view === 'history' && <HistoryView logs={logs} loading={loading} />}

            {view === 'scan' && (
              <RealScannerView 
                onDetected={handleScanSuccess} 
                onCancel={() => setView('home')} 
              />
            )}

            {view === 'product' && currentProduct && (
              <ProductDetailView 
                product={currentProduct}
                setProduct={setCurrentProduct}
                onSave={saveProductTransaction}
                onBack={() => setView('home')}
                inventory={inventory}
                logs={logs} 
              />
            )}
          </main>

          {(view === 'home' || view === 'history') && (
            <nav className="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-slate-200 px-6 pb-4 pt-2 flex justify-between items-end text-xs text-slate-500 z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
              <button onClick={() => setView('home')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${view === 'home' ? 'text-blue-600 font-bold' : 'text-slate-400'}`}>
                <Package size={24} /> <span>Stok</span>
              </button>

              <button onClick={handleManualAdd} className="flex flex-col items-center gap-1 text-slate-400 hover:text-blue-600 w-16">
                <PlusCircle size={24} /> <span>Tambah</span>
              </button>

              <button onClick={() => setView('scan')} className="flex flex-col items-center justify-center -mt-10 bg-blue-600 text-white w-16 h-16 rounded-full shadow-lg border-4 border-slate-100 active:scale-95 transition-transform">
                <Scan size={28} />
              </button>
              
               <button onClick={() => setView('history')} className={`flex flex-col items-center gap-1 w-16 transition-colors ${view === 'history' ? 'text-blue-600 font-bold' : 'text-slate-400'}`}>
                <History size={24} /> <span>Riwayat</span>
              </button>
            </nav>
          )}
        </div>
      );
    }

    /* --- COMPONENT: HOME VIEW --- */
    function HomeView({ inventory, onSearch, scannedCode, setScannedCode, onItemClick, loading }) {
      const items = Object.values(inventory);
      
      const now = new Date();
      const currentMonth = now.getMonth() + 1;
      const currentYear = now.getFullYear();
      
      const expiredCount = items.filter(i => {
         if (!i.expiryDate || i.expiryDate === '-') return false;
         const [m, y] = normalizeExpiry(i.expiryDate).split('/').map(Number);
         if (!y) return false;
         return y < currentYear || (y === currentYear && m < currentMonth);
      }).length;

      const totalStock = items.reduce((acc, curr) => acc + (parseInt(curr.stock) || 0), 0);

      const handleSearch = (e) => {
        e.preventDefault();
        onSearch(scannedCode.trim());
      };

      return (
        <div className="space-y-6">
          <div className="bg-gradient-to-r from-blue-600 to-indigo-700 p-5 rounded-2xl shadow-lg text-white relative overflow-hidden">
             <div className="absolute right-0 top-0 p-4 opacity-10">
               <Package size={100} />
             </div>
             <div className="relative z-10 flex justify-between items-start">
               <div>
                 <p className="text-blue-100 text-xs font-bold uppercase mb-1">Total Aset</p>
                 <p className="text-4xl font-black">{loading ? '...' : totalStock}</p>
                 <p className="text-[10px] opacity-80 mt-1">{items.length} Jenis Produk</p>
               </div>
               {expiredCount > 0 && (
                 <div className="bg-red-500/20 border border-red-400/30 rounded-lg p-2 text-right">
                    <p className="text-red-100 text-[10px] font-bold uppercase">Kadaluarsa</p>
                    <p className="text-xl font-bold text-red-50 flex items-center justify-end gap-1">
                      <AlertTriangle size={16} /> {expiredCount}
                    </p>
                 </div>
               )}
            </div>
          </div>

          <form onSubmit={handleSearch} className="bg-white p-2 rounded-xl shadow-sm border border-slate-200 flex gap-2">
            <div className="relative flex-1">
                <Search className="absolute left-3 top-2.5 text-slate-400" size={18} />
                <input 
                  type="text" 
                  placeholder="Scan atau ketik ID..." 
                  className="w-full pl-9 pr-4 py-2 bg-transparent text-sm focus:outline-none font-bold text-slate-700"
                  value={scannedCode}
                  onChange={(e) => setScannedCode(e.target.value)}
                />
            </div>
            <button type="submit" className="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg font-bold text-xs hover:bg-slate-200">
                Cari
            </button>
          </form>

          <div className="pb-10">
            <div className="flex justify-between items-center mb-3">
               <h2 className="font-bold text-slate-700 text-sm">Daftar Barang</h2>
            </div>
            
            {items.length === 0 ? (
              <div className="text-center py-10 text-slate-400 bg-white rounded-xl border border-dashed border-slate-300">
                <Package size={40} className="mx-auto mb-2 opacity-50" />
                <p className="text-xs">Belum ada data barang.</p>
              </div>
            ) : (
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden divide-y divide-slate-100">
                {items.map((item) => {
                  let expBadgeColor = "bg-slate-100 text-slate-500";
                  if (item.expiryDate && item.expiryDate !== '-') {
                     const [m, y] = normalizeExpiry(item.expiryDate).split('/').map(Number);
                     if (y < currentYear || (y === currentYear && m < currentMonth)) {
                        expBadgeColor = "bg-red-100 text-red-600 border-red-200"; 
                     } else if (y === currentYear && m === currentMonth) {
                        expBadgeColor = "bg-orange-100 text-orange-600 border-orange-200"; 
                     } else {
                        expBadgeColor = "bg-blue-50 text-blue-600 border-blue-100"; 
                     }
                  }

                  return (
                    <div key={item.id} onClick={() => onItemClick(item)} className="p-4 flex justify-between items-center hover:bg-slate-50 active:bg-slate-100 cursor-pointer transition-colors">
                      <div>
                        <p className="font-bold text-slate-800 text-sm">{item.name || 'Tanpa Nama'}</p>
                        <div className="flex flex-wrap items-center gap-2 mt-1">
                            <span className="text-[10px] text-slate-400 font-mono bg-slate-100 px-1.5 py-0.5 rounded border border-slate-200">{item.id}</span>
                            {item.expiryDate && item.expiryDate !== '-' && (
                                <span className={`text-[10px] flex items-center gap-1 px-1.5 py-0.5 rounded border font-bold ${expBadgeColor}`}>
                                    <Calendar size={8} /> {item.expiryDate}
                                </span>
                            )}
                        </div>
                      </div>
                      <div className={`px-3 py-1 rounded-full text-xs font-bold ${item.stock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                        {item.stock} Unit
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
          </div>
        </div>
      );
    }

    /* --- COMPONENT: PRODUCT DETAIL VIEW (UPDATED) --- */
    function ProductDetailView({ product, setProduct, onSave, onBack, inventory, logs }) {
      const [mode, setMode] = useState('view');
      const [amount, setAmount] = useState('');
      const [newName, setNewName] = useState(product.name);
      
      const [editableId, setEditableId] = useState(product.id || '');

      // --- LOGIC FILTER OTOMATIS (PERBAIKAN UTAMA: NORMALISASI) ---
      const availableExpiries = useMemo(() => {
        const dates = new Set();
        // 1. Ambil dari status produk saat ini (Inventory)
        if (product.expiryDate && product.expiryDate !== '-') dates.add(normalizeExpiry(product.expiryDate));
        
        // 2. Ambil dari LOGS (Agar expired lama juga muncul di dropdown)
        if (logs && logs.length > 0) {
            logs.forEach(log => {
                if (String(log.productId) === String(product.id) && log.expiryDate && log.expiryDate !== '-') {
                    dates.add(normalizeExpiry(log.expiryDate));
                }
            });
        }
        
        return Array.from(dates).sort((a, b) => {
            const [mA, yA] = a.split('/').map(Number);
            const [mB, yB] = b.split('/').map(Number);
            return yB - yA || mB - mA;
        });
      }, [product, logs]);

      // State Expired (Untuk Filter & Input Baru)
      const defaultExp = product.expiryDate && product.expiryDate !== '-' 
        ? normalizeExpiry(product.expiryDate).split('/') 
        : [new Date().getMonth() + 1, new Date().getFullYear() + 1];
        
      const [expMonth, setExpMonth] = useState(parseInt(defaultExp[0]) || new Date().getMonth() + 1);
      const [expYear, setExpYear] = useState(parseInt(defaultExp[1]) || new Date().getFullYear() + 1);
      
      const [selectedFilterExp, setSelectedFilterExp] = useState(
          product.expiryDate && product.expiryDate !== '-' ? normalizeExpiry(product.expiryDate) : (availableExpiries[0] || '')
      );

      // --- LOGIC PERHITUNGAN STOK BATCH (FIX UTAMA: NORMALISASI) ---
      const calculatedBatchStock = useMemo(() => {
          if (!selectedFilterExp || selectedFilterExp === '-') return 0;
          
          let count = 0;
          // Loop semua logs dengan tanggal yang SUDAH DINORMALISASI
          logs.forEach(log => {
             if (String(log.productId) === String(product.id)) {
                 const logExp = normalizeExpiry(log.expiryDate);
                 // Bandingkan tanggal yang sudah bersih
                 if (logExp === selectedFilterExp) {
                     const qty = parseInt(log.amount) || 0;
                     if (log.type === 'in' || log.type === 'new') {
                         count += qty;
                     } else if (log.type === 'out') {
                         count -= qty;
                     }
                 }
             }
          });
          return count;
      }, [selectedFilterExp, logs, product.id]);

      useEffect(() => {
        if (selectedFilterExp && selectedFilterExp !== '-') {
            const [m, y] = selectedFilterExp.split('/').map(Number);
            if (m && y) {
                setExpMonth(m);
                setExpYear(y);
            }
        }
      }, [selectedFilterExp]);

      const handleSubmit = () => {
        if (!amount || parseInt(amount) <= 0) return;
        
        const finalId = product.isManualInput ? editableId : product.id;
        if (!finalId.trim()) {
            alert("ID Produk / Barcode tidak boleh kosong!");
            return;
        }

        const type = mode === 'add' ? 'in' : 'out';
        const formattedExpiry = `${String(expMonth).padStart(2, '0')}/${expYear}`;
        
        onSave(finalId, amount, type, formattedExpiry, newName);
      };

      const months = [
        {v:1, l:'Jan'}, {v:2, l:'Feb'}, {v:3, l:'Mar'}, {v:4, l:'Apr'},
        {v:5, l:'Mei'}, {v:6, l:'Jun'}, {v:7, l:'Jul'}, {v:8, l:'Agu'},
        {v:9, l:'Sep'}, {v:10, l:'Okt'}, {v:11, l:'Nov'}, {v:12, l:'Des'}
      ];

      const currentSelectedExpiry = `${String(expMonth).padStart(2, '0')}/${expYear}`;
      const isCurrentExpiryMatch = normalizeExpiry(product.expiryDate) === currentSelectedExpiry;

      return (
        <div className="space-y-4 animate-in slide-in-from-bottom-4 duration-300 pb-20">
          <button onClick={onBack} className="flex items-center text-slate-500 hover:text-slate-800 mb-2 font-bold text-xs">
            <ArrowLeft size={16} className="mr-1" /> KEMBALI
          </button>

          {/* DETAIL BARANG CARD */}
          <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 text-center relative overflow-hidden">
            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-400 to-blue-600"></div>
            
            <div className="mb-4">
              {product.isNew ? (
                 <div className="space-y-3">
                     <input
                        type="text"
                        value={newName}
                        onChange={(e) => { setNewName(e.target.value); setProduct(prev => ({...prev, name: e.target.value})); }}
                        placeholder="Nama Produk Baru..."
                        className="w-full text-center text-xl font-bold border-b-2 border-blue-100 focus:border-blue-500 outline-none pb-2 placeholder:text-slate-300 bg-transparent"
                        autoFocus
                      />
                      {product.isManualInput ? (
                        <div className="flex flex-col items-center">
                            <label className="text-[10px] text-slate-400 uppercase font-bold mb-1">Barcode / ID (Wajib Isi)</label>
                            <div className="flex items-center justify-center gap-2 border border-slate-300 rounded-lg px-3 py-2 bg-slate-50 w-full">
                                <Edit3 size={14} className="text-slate-400" />
                                <input 
                                    type="text"
                                    value={editableId}
                                    onChange={(e) => setEditableId(e.target.value.toUpperCase())}
                                    placeholder="Ketik ID / Scan..."
                                    className="bg-transparent outline-none text-sm font-mono font-bold text-slate-700 text-center w-full"
                                />
                            </div>
                        </div>
                      ) : (
                        <div className="flex items-center justify-center gap-1 text-slate-400 text-xs font-mono bg-slate-100 py-1 px-3 rounded-full mx-auto w-fit">
                           ID: {product.id}
                        </div>
                      )}
                 </div>
              ) : (
                <>
                    <h2 className="text-xl font-bold text-slate-800 leading-tight">{product.name}</h2>
                    <p className="text-xs text-slate-400 font-mono mt-1">{product.id}</p>
                    {product.expiryDate && product.expiryDate !== '-' && (
                      <div className="mt-2 inline-flex items-center gap-1 bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold">
                        <Calendar size={12} /> Exp Terkini: {product.expiryDate}
                      </div>
                    )}
                </>
              )}
            </div>

            <div className="py-2 border-t border-slate-100 mt-4">
              <span className="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Total Stok Keseluruhan</span>
              <div className="text-5xl font-black text-slate-800 mt-1">{product.stock}</div>
            </div>
            
            {/* FITUR FILTER STOK EXPIRED */}
            {!product.isNew && (
                <div className="mt-4 bg-slate-50 rounded-xl p-3 text-left border border-slate-200">
                    <p className="text-[10px] font-bold text-slate-500 mb-2 flex items-center gap-1 uppercase">
                        <Filter size={10} /> Cek Stok Per Batch (Expired)
                    </p>
                    
                    {/* DROPDOWN FILTER UTAMA */}
                    <div className="relative mb-3">
                        {availableExpiries.length > 0 ? (
                            <select 
                                value={selectedFilterExp}
                                onChange={(e) => setSelectedFilterExp(e.target.value)}
                                className="w-full p-2 bg-white border border-slate-300 rounded-lg text-sm font-bold text-slate-700 outline-none appearance-none"
                            >
                                {availableExpiries.map(exp => (
                                    <option key={exp} value={exp}>
                                        {exp} {normalizeExpiry(product.expiryDate) === exp ? '(Terbaru)' : ''}
                                    </option>
                                ))}
                            </select>
                        ) : (
                            <div className="w-full p-2 bg-slate-100 border border-slate-200 rounded-lg text-sm text-slate-400 italic text-center">
                                Belum ada data expired
                            </div>
                        )}
                        {availableExpiries.length > 0 && (
                            <ChevronDown size={16} className="absolute right-3 top-2.5 text-slate-400 pointer-events-none" />
                        )}
                    </div>
                    
                    <div className="flex justify-between items-center bg-white p-2 rounded border border-slate-200 shadow-sm">
                        <span className="text-xs text-slate-500">Sisa Stok Batch Ini:</span>
                        <span className="font-bold text-blue-600 text-sm">
                            {calculatedBatchStock} Unit
                        </span>
                    </div>
                    <p className="text-[9px] text-slate-400 mt-1 italic leading-tight">
                        *Dihitung berdasarkan riwayat transaksi Masuk & Keluar untuk tanggal expired tersebut.
                    </p>
                </div>
            )}
          </div>

          {mode === 'view' ? (
            <div className="grid grid-cols-2 gap-3">
              <button 
                onClick={() => setMode('add')}
                className="flex items-center justify-center gap-3 p-4 bg-green-600 text-white rounded-xl shadow-lg active:scale-95 transition-transform"
              >
                <PlusCircle size={24} />
                <div className="text-left">
                    <p className="font-bold text-sm">Masuk</p>
                    <p className="text-[10px] opacity-80">Tambah Stok</p>
                </div>
              </button>

              <button 
                onClick={() => setMode('remove')}
                className="flex items-center justify-center gap-3 p-4 bg-red-600 text-white rounded-xl shadow-lg active:scale-95 transition-transform"
              >
                <Minus size={24} />
                <div className="text-left">
                    <p className="font-bold text-sm">Keluar</p>
                    <p className="text-[10px] opacity-80">Kurang Stok</p>
                </div>
              </button>
            </div>
          ) : (
            <div className="bg-white p-5 rounded-xl shadow-lg border border-slate-100 animate-in zoom-in-95 duration-200 mt-4 relative">
              <button onClick={() => setMode('view')} className="absolute top-4 right-4 text-slate-300 hover:text-slate-500">
                <X size={24} />
              </button>
              
              <h3 className={`font-bold text-lg mb-6 flex items-center gap-2 ${mode === 'add' ? 'text-green-600' : 'text-red-600'}`}>
                 {mode === 'add' ? <PlusCircle /> : <Minus />} 
                 {mode === 'add' ? 'Barang Masuk' : 'Barang Keluar'}
              </h3>

              <div className="flex gap-3 items-center mb-6">
                <button 
                  onClick={() => setAmount(prev => Math.max(0, (parseInt(prev)||0) - 1).toString())}
                  className="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center font-bold text-xl text-slate-600 active:bg-slate-200"
                >-</button>
                <input 
                  type="number" 
                  value={amount}
                  onChange={(e) => setAmount(e.target.value)}
                  placeholder="0"
                  className="flex-1 text-center text-4xl font-bold py-2 outline-none text-slate-800 border-b border-slate-100 focus:border-blue-500 transition-colors"
                  autoFocus
                />
                <button 
                  onClick={() => setAmount(prev => ((parseInt(prev)||0) + 1).toString())}
                  className="w-12 h-12 bg-slate-100 rounded-xl flex items-center justify-center font-bold text-xl text-slate-600 active:bg-slate-200"
                >+</button>
              </div>

              {/* INPUT EXPIRED DATE (MANUAL YEAR - TETAP ADA UNTUK INPUT DATA BARU) */}
              <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-6">
                 <p className="text-xs font-bold text-slate-500 mb-2 flex items-center gap-1">
                   <Calendar size={14}/> Set Tanggal Kadaluarsa
                 </p>
                 <div className="flex gap-2">
                    <select 
                      value={expMonth} 
                      onChange={(e) => setExpMonth(e.target.value)}
                      className="flex-1 p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none focus:border-blue-500 appearance-none text-center"
                    >
                      {months.map(m => <option key={m.v} value={m.v}>{m.l} ({m.v})</option>)}
                    </select>
                    
                    {/* INPUT TAHUN MANUAL */}
                    <input 
                      type="number"
                      value={expYear}
                      onChange={(e) => setExpYear(e.target.value)}
                      placeholder="Tahun (YYYY)"
                      className="flex-1 p-2 bg-white border border-slate-200 rounded-lg text-sm font-bold text-slate-700 outline-none focus:border-blue-500 text-center"
                    />
                 </div>
                 <p className="text-[10px] text-slate-400 mt-2 text-center">
                    {mode === 'add' ? 'Set Expired batch baru ini' : 'Update Expired batch yang dikeluarkan'}
                 </p>
              </div>

              <button 
                onClick={handleSubmit}
                disabled={!amount || parseInt(amount) <= 0}
                className={`w-full py-4 rounded-xl font-bold text-white shadow-md text-lg flex items-center justify-center gap-2 transition-colors ${
                  mode === 'add' 
                    ? 'bg-green-600 hover:bg-green-700 disabled:bg-slate-300' 
                    : 'bg-red-600 hover:bg-red-700 disabled:bg-slate-300'
                }`}
              >
                <Save size={20} /> KONFIRMASI
              </button>
            </div>
          )}
        </div>
      );
    }

    function HistoryView({ logs, loading }) {
       const displayLogs = logs.slice(0, 30);
       if (loading) return <div className="p-10 text-center"><Loader2 className="animate-spin mx-auto"/></div>;

       return (
         <div className="space-y-4 pb-20">
            <h2 className="font-bold text-xl text-slate-800 flex items-center gap-2 px-2">
              <Clock className="text-blue-600" /> Riwayat Transaksi
            </h2>
            {displayLogs.length === 0 ? (
               <div className="text-center text-slate-400 py-10">Belum ada riwayat.</div>
            ) : (
               <div className="space-y-3">
                 {displayLogs.map((log, idx) => (
                    <div key={idx} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex justify-between items-center">
                       <div className="flex items-center gap-3">
                          <div className={`p-2 rounded-lg ${log.type === 'out' ? 'bg-red-50 text-red-600' : 'bg-green-50 text-green-600'}`}>
                             {log.type === 'out' ? <ArrowUpRight size={18}/> : <ArrowDownLeft size={18}/>}
                          </div>
                          <div>
                             <p className="font-bold text-slate-700 text-sm">{log.productName}</p>
                             <div className="flex gap-2 text-[10px] text-slate-400 mt-0.5">
                                <span>{new Date(log.timestamp).toLocaleString('id-ID')}</span>
                                {log.expiryDate && <span>| Exp: {log.expiryDate}</span>}
                             </div>
                          </div>
                       </div>
                       <div className={`font-black text-lg ${log.type === 'out' ? 'text-red-600' : 'text-green-600'}`}>
                          {log.type === 'out' ? '-' : '+'}{log.amount}
                       </div>
                    </div>
                 ))}
               </div>
            )}
         </div>
       );
    }

    /* --- SCANNER ASLI (REAL TIME) --- */
    function RealScannerView({ onDetected, onCancel }) {
      useEffect(() => {
        // Inisialisasi Scanner
        const scannerId = "reader";
        let html5QrcodeScanner;

        // Beri sedikit delay agar DOM reader siap
        const timer = setTimeout(() => {
            html5QrcodeScanner = new Html5QrcodeScanner(
                scannerId, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                /* verbose= */ false
            );
            
            html5QrcodeScanner.render(
                (decodedText) => {
                    // Success callback
                    html5QrcodeScanner.clear();
                    onDetected(decodedText);
                }, 
                (errorMessage) => {
                    // Error callback (scan in progress)
                    // console.log(errorMessage); 
                }
            );
        }, 100);

        return () => {
            clearTimeout(timer);
            if(html5QrcodeScanner) {
                html5QrcodeScanner.clear().catch(error => console.error("Failed to clear scanner", error));
            }
        };
      }, []);

      return (
        <div className="fixed inset-0 bg-black z-50 flex flex-col">
          <div className="relative flex-1 flex flex-col items-center justify-center p-4">
            
            <div className="bg-white p-1 rounded-2xl w-full max-w-sm overflow-hidden relative">
                <div id="reader" className="w-full h-full bg-slate-900 rounded-xl overflow-hidden min-h-[300px]"></div>
                
                {/* Overlay garis merah scanning */}
                <div className="absolute top-1/2 left-4 right-4 h-0.5 bg-red-500 shadow-[0_0_10px_red] animate-pulse pointer-events-none z-10"></div>
            </div>

            <p className="text-white text-sm mt-6 font-medium text-center">
                Arahkan kamera ke Barcode / QR Code
            </p>
            <p className="text-slate-400 text-xs mt-1 text-center">
                Pastikan cahaya cukup terang
            </p>

            <button onClick={onCancel} className="mt-8 bg-slate-800 text-white px-6 py-3 rounded-full font-bold flex items-center gap-2 hover:bg-slate-700 border border-slate-700">
                <X size={18} /> Batalkan
            </button>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
