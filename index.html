<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    
    <!-- PWA Meta Tags (iOS Support) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SNM Stock">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Favicon Basic -->
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/d/1KS7axzFBOhVQLFypkDqLkLP71iNu8x9X">
    <link rel="apple-touch-icon" href="https://lh3.googleusercontent.com/d/1KS7axzFBOhVQLFypkDqLkLP71iNu8x9X">

    <title>SNM-Stock - Cloud WMS</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Code Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Dynamic Manifest Script -->
    <script>
        const logoUrl = "https://lh3.googleusercontent.com/d/1KS7axzFBOhVQLFypkDqLkLP71iNu8x9X";
        
        const manifestData = {
            "name": "SNM Stock WMS",
            "short_name": "SNM Stock",
            "start_url": window.location.href, 
            "display": "standalone", 
            "background_color": "#ffffff",
            "theme_color": "#2563eb",
            "orientation": "portrait",
            "icons": [
                { "src": logoUrl, "sizes": "192x192", "type": "image/png" },
                { "src": logoUrl, "sizes": "512x512", "type": "image/png" }
            ]
        };

        const stringManifest = JSON.stringify(manifestData);
        const blob = new Blob([stringManifest], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        
        const link = document.createElement('link');
        link.rel = 'manifest';
        link.href = manifestURL;
        document.head.appendChild(link);
    </script>

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    },
                    screens: {
                        'xs': '380px',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; 
        }
        
        .glass-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
        }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 10px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        #reader { width: 100%; border-radius: 1rem; overflow: hidden; background: #000; }
        #reader video { object-fit: cover; border-radius: 1rem; width: 100% !important; height: 100% !important; }
        
        .img-fallback { display: none; }
        
        /* Markdown simple styling */
        .prose ul { list-style-type: disc; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose ol { list-style-type: decimal; padding-left: 1.2em; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 0.5em; }
        .prose strong { font-weight: 700; color: #1e293b; }
    </style>
</head>
<body class="h-screen overflow-hidden bg-slate-50 text-slate-900">

    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { 
          LayoutDashboard, Package, ArrowDownCircle, ArrowUpCircle, Search, Plus, 
          AlertTriangle, TrendingDown, MapPin, Trash2, ScanBarcode, Warehouse, 
          X, Menu, LogOut, Users, Lock, UserPlus, Settings, CheckCircle, Info, 
          Box, ArrowRight, Activity, BarChart3, Cloud, Smartphone, Loader2,
          Home, History, Camera, ChevronLeft, User, ShieldCheck, RefreshCw,
          Calendar, FileSpreadsheet, Filter, Download, Archive, ClipboardList, Save,
          ArrowRightLeft, Layers, Database, Clipboard, Check, Sparkles, Bot, Send, MessageSquare, KeyRound, Share2
        } from 'https://esm.sh/lucide-react@0.292.0';

        // ==========================================
        // KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyBhsBxRsq9bUJ8lY2YwVCM7Wh8l0HWSrt0",
          authDomain: "wms-nsm.firebaseapp.com",
          projectId: "wms-nsm",
          storageBucket: "wms-nsm.firebasestorage.app",
          messagingSenderId: "241652922316",
          appId: "1:241652922316:web:316e6376ecd23078498f69"
        };
        
        if (!firebase.apps.length) {
            try {
                firebase.initializeApp(firebaseConfig);
            } catch (e) {
                console.error("Firebase Init Error:", e);
            }
        }
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'wms-nsm-production'; 
        const COLLECTION_PATH = (name) => `wms_data/${appId}/${name}`;
        const LOGO_URL = "https://lh3.googleusercontent.com/d/1KS7axzFBOhVQLFypkDqLkLP71iNu8x9X";

        // --- GEMINI API SETUP ---
        // API Key telah ditambahkan sesuai permintaan
        const defaultApiKey = "AIzaSyBbejQVbqt3OR4V92t4O2ly9wc78IKgMpQ";
        
        const callGemini = async (prompt) => {
            // Cek key dari LocalStorage (Input User) ATAU default key (Hardcoded)
            const userApiKey = localStorage.getItem('snm_gemini_api_key');
            const effectiveKey = userApiKey || defaultApiKey;

            if (!effectiveKey) return "MISSING_KEY";
            
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${effectiveKey}`;
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error?.message || "Gagal menghubungi AI");
                }
                
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, saya tidak bisa menjawab saat ini.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Terjadi kesalahan saat menghubungi AI: " + error.message;
            }
        };

        const getFormattedDate = (timestamp) => {
            return new Intl.DateTimeFormat('id-ID', {
                day: '2-digit', month: 'short', year: '2-digit',
                hour: '2-digit', minute: '2-digit'
            }).format(new Date(timestamp));
        };

        const useFirestoreCollection = (collectionName, firebaseUser, isAuthReady, onPermissionError) => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            useEffect(() => {
                if (!firebaseUser || !isAuthReady) return;
                const path = COLLECTION_PATH(collectionName);
                let unsubscribe;
                try {
                    unsubscribe = db.collection(path)
                        .onSnapshot(snapshot => {
                            const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                            setData(items);
                            setLoading(false);
                        }, error => {
                            console.error(`Error fetching ${collectionName}:`, error);
                            if (error.code === 'permission-denied') {
                                if (onPermissionError) onPermissionError();
                            }
                            setLoading(false);
                        });
                } catch (e) {
                    console.error("Collection Error", e);
                    setLoading(false);
                }
                return () => unsubscribe && unsubscribe();
            }, [firebaseUser, collectionName, isAuthReady]);
            return { data, loading };
        };

        const Modal = ({ isOpen, title, children, onClose, type = 'default' }) => {
            if (!isOpen) return null;
            const colors = {
                default: 'bg-white text-slate-800',
                danger: 'bg-red-50 text-red-700',
                success: 'bg-emerald-50 text-emerald-700',
                info: 'bg-blue-50 text-blue-800',
                ai: 'bg-gradient-to-r from-indigo-600 to-violet-600 text-white'
            };
            return (
                <div className="fixed inset-0 bg-slate-900/70 z-[60] flex items-end sm:items-center justify-center sm:p-4 backdrop-blur-sm animate-fade-in" style={{zIndex: 100}}>
                    <div className="bg-white w-full sm:max-w-md sm:rounded-3xl rounded-t-3xl shadow-2xl flex flex-col max-h-[90vh] animate-slide-up sm:animate-fade-in">
                        <div className={`px-6 py-4 flex justify-between items-center border-b border-slate-100 sm:rounded-t-3xl rounded-t-3xl ${colors[type]}`}>
                            <h3 className="font-bold text-lg flex items-center gap-2.5 tracking-tight">
                                {type === 'danger' && <AlertTriangle size={20}/>}
                                {type === 'success' && <CheckCircle size={20}/>}
                                {type === 'info' && <Info size={20}/>}
                                {type === 'ai' && <Sparkles size={20}/>}
                                {title}
                            </h3>
                            <button onClick={onClose} className={`p-2 rounded-full ${type === 'ai' ? 'hover:bg-white/10 text-white' : 'hover:bg-black/5 text-slate-800'}`}><X size={20}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar flex-1">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };
        
        const PermissionErrorScreen = () => (
            <div className="fixed inset-0 z-[999] bg-slate-900 flex flex-col items-center justify-center p-6 text-white overflow-y-auto">
                <div className="max-w-lg w-full space-y-6 animate-slide-up">
                    <div className="flex flex-col items-center text-center">
                        <div className="w-20 h-20 bg-red-500/20 text-red-500 rounded-3xl flex items-center justify-center mb-4 animate-pulse">
                            <Lock size={40} />
                        </div>
                        <h1 className="text-2xl font-bold mb-2">Akses Database Ditolak</h1>
                        <p className="text-slate-400 text-sm">Aplikasi masih terblokir. Pastikan Anda sudah menyimpan Rules dengan benar.</p>
                    </div>
                    <button onClick={()=>window.location.reload()} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition-all active:scale-95 flex items-center justify-center gap-2">
                        <RefreshCw size={20}/> Coba Refresh
                    </button>
                </div>
            </div>
        );

        const BottomNavItem = ({ icon: Icon, label, active, onClick }) => (
            <button onClick={onClick} className={`flex flex-col items-center justify-center py-2 px-1 flex-1 transition-colors ${active ? 'text-blue-600' : 'text-slate-400 hover:text-slate-600'}`}>
                <Icon size={24} strokeWidth={active ? 2.5 : 2} className={`mb-1 ${active ? '-translate-y-1' : ''} transition-transform duration-200`} />
                <span className="text-[10px] font-bold">{label}</span>
            </button>
        );

        function App() {
            const [authReady, setAuthReady] = useState(false);
            const [firebaseUser, setFirebaseUser] = useState(null);
            const [permissionError, setPermissionError] = useState(false);
            const handlePermissionError = () => { if (!permissionError) setPermissionError(true); };

            const { data: users, loading: loadingUsers } = useFirestoreCollection('users', firebaseUser, authReady, handlePermissionError);
            const { data: inventory, loading: loadingInv } = useFirestoreCollection('inventory', firebaseUser, authReady, handlePermissionError);
            const { data: locations, loading: loadingLoc } = useFirestoreCollection('locations', firebaseUser, authReady, handlePermissionError);
            const { data: logs, loading: loadingLogs } = useFirestoreCollection('logs', firebaseUser, authReady, handlePermissionError);
            const { data: packingLogs, loading: loadingPacking } = useFirestoreCollection('packing_logs', firebaseUser, authReady, handlePermissionError);
            // Fetch Global Settings (API Key) from Firestore
            const { data: settingsData } = useFirestoreCollection('settings', firebaseUser, authReady, handlePermissionError);

            const [currentUser, setCurrentUser] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [isScanning, setIsScanning] = useState(false);
            const html5QrCodeRef = useRef(null);
            
            // AI State
            const [aiModalOpen, setAiModalOpen] = useState(false);
            const [aiLoading, setAiLoading] = useState(false);
            const [aiResponse, setAiResponse] = useState(null);
            const [aiQuery, setAiQuery] = useState('');
            const [aiMode, setAiMode] = useState('analysis'); 
            
            // Global API Key Management
            const [apiKeyInput, setApiKeyInput] = useState('');
            const [showKeyInput, setShowKeyInput] = useState(false);
            
            // Derived Global API Key from Firestore
            const globalApiKey = useMemo(() => {
                const configDoc = settingsData.find(d => d.id === 'ai_config');
                // Prioritas: Key dari Cloud > Key Hardcoded (defaultApiKey)
                return configDoc && configDoc.apiKey ? configDoc.apiKey : defaultApiKey;
            }, [settingsData]);

            // Auto-open key input if no key found in DB and no default key
            useEffect(() => {
                if (aiModalOpen && !globalApiKey) {
                    setShowKeyInput(true);
                } else if (globalApiKey) {
                    setShowKeyInput(false);
                }
            }, [aiModalOpen, globalApiKey]);


            const [packingInput, setPackingInput] = useState({}); 
            const [moveItem, setMoveItem] = useState(null);
            const [moveSourceId, setMoveSourceId] = useState('');
            const [moveTargetLocation, setMoveTargetLocation] = useState('');
            const [moveQty, setMoveQty] = useState('');

            const [filterType, setFilterType] = useState('daily');
            const [customDateStart, setCustomDateStart] = useState('');
            const [customDateEnd, setCustomDateEnd] = useState('');

            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [newItem, setNewItem] = useState({ name: '', sku: '', barcode: '', qty: 0, location: '' });
            const [newLocation, setNewLocation] = useState({ code: '', name: '' });
            const [transaction, setTransaction] = useState({ itemId: '', qty: '', notes: '', targetLocation: '' });
            const [scanQuery, setScanQuery] = useState('');
            const [scanResult, setScanResult] = useState(null);
            const [selectedLocation, setSelectedLocation] = useState(null);
            const [newUser, setNewUser] = useState({ username: '', password: '', name: '', role: 'staff' });
            const [profileData, setProfileData] = useState({ name: '', username: '', password: '' });

            const [modals, setModals] = useState({
                add: false, loc: false, users: false, profile: false,
                alert: { isOpen: false, title: '', message: '', type: 'default' },
                confirm: { isOpen: false, message: '', onConfirm: null }
            });
            
            const isAdmin = currentUser?.role === 'admin';

            const groupedInventory = useMemo(() => {
                const groups = {};
                inventory.forEach(item => {
                    if (!groups[item.sku]) { groups[item.sku] = { ...item, totalQty: 0, locations: [] }; }
                    groups[item.sku].totalQty += (parseInt(item.qty) || 0);
                    groups[item.sku].locations.push({ id: item.id, code: item.location, qty: item.qty });
                });
                return Object.values(groups);
            }, [inventory]);

            // --- HISTORY HANDLING ---
            useEffect(() => {
                window.history.replaceState({ tab: 'dashboard' }, '', '#dashboard');
                const handlePopState = (event) => {
                    if (event.state && event.state.tab) {
                        setActiveTab(event.state.tab);
                        setIsSidebarOpen(false);
                        setIsScanning(false);
                        setScanResult(null);
                    } else {
                        setActiveTab('dashboard');
                    }
                };
                window.addEventListener('popstate', handlePopState);
                return () => window.removeEventListener('popstate', handlePopState);
            }, []);

            useEffect(() => {
                let isMounted = true;
                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                        if(isMounted) {
                            setFirebaseUser(auth.currentUser);
                            setAuthReady(true);
                            const savedUser = localStorage.getItem('snm_active_user');
                            if (savedUser) setCurrentUser(JSON.parse(savedUser));
                        }
                    } catch (error) {
                        setModals(p => ({...p, alert: {isOpen: true, title: "Auth Error", message: "Gagal koneksi database.", type: "danger"}}));
                    }
                };
                initAuth();
                return () => { isMounted = false; };
            }, []);

            useEffect(() => {
                if (authReady && firebaseUser && !loadingUsers) {
                    const ensureData = async () => {
                        try {
                            const adminExists = users.some(u => u.username === 'admin');
                            if (!adminExists) { await db.collection(COLLECTION_PATH('users')).add({ username: 'admin', password: '123', name: 'Super Admin', role: 'admin', createdAt: Date.now() }); }
                            if (locations.length === 0) {
                                const locRef = db.collection(COLLECTION_PATH('locations'));
                                const snap = await locRef.get(); 
                                if(snap.empty) { await locRef.add({ code: 'A-01', name: 'Rak Depan' }); await locRef.add({ code: 'B-02', name: 'Gudang Belakang' }); }
                            }
                        } catch (e) { if (e.code === 'permission-denied') handlePermissionError(); }
                    };
                    ensureData();
                }
            }, [authReady, firebaseUser, loadingUsers, users.length, locations.length]);

            const showAlert = (message, title="Info", type="default") => setModals(p => ({ ...p, alert: { isOpen: true, title, message, type } }));
            const closeAlert = () => setModals(p => ({ ...p, alert: { ...p.alert, isOpen: false } }));
            const showConfirm = (message, onConfirm) => setModals(p => ({ ...p, confirm: { isOpen: true, message, onConfirm } }));
            const closeConfirm = () => setModals(p => ({ ...p, confirm: { ...p.confirm, isOpen: false } }));

            const handleLogin = (e) => {
                e.preventDefault();
                if (!authReady) return showAlert("Menunggu koneksi database...", "Loading");
                const validUser = users.find(u => u.username.toLowerCase() === loginForm.username.toLowerCase() && u.password === loginForm.password);
                if (validUser) {
                    const userSession = { ...validUser, loginTime: Date.now() };
                    setCurrentUser(userSession);
                    localStorage.setItem('snm_active_user', JSON.stringify(userSession));
                    setLoginForm({username:'', password:''});
                    navigateTo('dashboard');
                } else {
                    setLoginError('Username atau Password salah.');
                }
            };

            const navigateTo = (tab) => {
                if (tab !== activeTab) {
                    window.history.pushState({ tab: tab }, '', `#${tab}`);
                    setActiveTab(tab);
                    setIsSidebarOpen(false);
                    if (isScanning) stopScanner();
                }
            };

            const SidebarLink = ({ tab, icon: Icon, label }) => (
                <button onClick={() => navigateTo(tab)} className={`w-full flex items-center gap-3 px-4 py-3 mb-1 rounded-xl transition-all duration-200 ${activeTab === tab ? 'bg-blue-50 text-blue-600 font-bold shadow-sm' : 'text-slate-500 hover:bg-slate-50 font-medium'}`}>
                    <Icon size={20} className={activeTab === tab ? "text-blue-600" : "text-slate-400"} strokeWidth={activeTab === tab ? 2.5 : 2} />
                    <span className="text-sm">{label}</span>
                </button>
            );

            // --- GEMINI AI FUNCTIONS (UPDATED FOR CLOUD SYNC) ---
            
            // Save API Key to Cloud (Firestore)
            const saveApiKey = async () => {
                if (!apiKeyInput.trim()) return showAlert("API Key tidak boleh kosong", "Error", "warning");
                
                try {
                    // Save to 'settings/ai_config'
                    await db.collection(COLLECTION_PATH('settings')).doc('ai_config').set({
                        apiKey: apiKeyInput,
                        updatedAt: Date.now(),
                        updatedBy: currentUser.name
                    });
                    
                    setApiKeyInput('');
                    setShowKeyInput(false);
                    showAlert("API Key berhasil disimpan ke Cloud. Semua perangkat kini bisa menggunakan AI.", "Sukses", "success");
                } catch (error) {
                    console.error("Save Key Error:", error);
                    showAlert("Gagal menyimpan key ke database: " + error.message, "Error", "danger");
                }
            };

            // Call Gemini using key from Cloud State
            const callGeminiWithState = async (prompt) => {
                // Use globalApiKey from Firestore (or default if Firestore is empty but default is set)
                if (!globalApiKey) return "MISSING_KEY";
                
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${globalApiKey}`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: prompt }] }]
                        })
                    });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "Gagal menghubungi AI");
                    }
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, saya tidak bisa menjawab saat ini.";
                } catch (error) {
                    console.error("Gemini Error:", error);
                    return "Terjadi kesalahan saat menghubungi AI: " + error.message;
                }
            };

            const prepareInventoryContext = () => {
                const contextData = groupedInventory.map(i => ({
                    name: i.name,
                    sku: i.sku,
                    total: i.totalQty,
                    locs: i.locations.map(l => `${l.code}(${l.qty})`).join(', ')
                })).slice(0, 50); 
                return JSON.stringify(contextData);
            };

            const handleAiAnalysis = async () => {
                setAiMode('analysis');
                setAiLoading(true);
                setAiResponse(null);
                
                const context = prepareInventoryContext();
                const prompt = `Bertindaklah sebagai manajer gudang profesional. Berikut adalah data stok gudang saya dalam format JSON: ${context}. Tolong berikan analisis singkat (maksimal 3 poin penting) mengenai kesehatan stok, barang yang perlu dipesan ulang segera (stok < 10), dan anomali jika ada. Gunakan format Markdown untuk styling (bold, list). Gunakan Bahasa Indonesia.`;
                
                const response = await callGeminiWithState(prompt);
                
                if (response === "MISSING_KEY") {
                    setAiResponse(null);
                    setAiLoading(false);
                    setShowKeyInput(true);
                    return;
                }
                setAiResponse(response);
                setAiLoading(false);
            };

            const handleAiChat = async (e) => {
                e.preventDefault();
                if(!aiQuery.trim()) return;
                
                setAiMode('chat');
                setAiLoading(true);
                
                const context = prepareInventoryContext();
                const prompt = `Berikut adalah data stok gudang: ${context}. Jawab pertanyaan user berikut berdasarkan data tersebut: '${aiQuery}'. Jawab dengan ringkas, ramah, dan membantu dalam Bahasa Indonesia. Jika ditanya tentang barang yang tidak ada di list, katakan tidak ditemukan data.`;
                
                const response = await callGeminiWithState(prompt);
                
                if (response === "MISSING_KEY") {
                    setAiResponse(null);
                    setAiLoading(false);
                    setShowKeyInput(true);
                    return;
                }
                setAiResponse(response);
                setAiLoading(false);
                setAiQuery('');
            };

            const stopScanner = async () => {
                setIsScanning(false);
            };

            const startScanner = () => {
                setIsScanning(true);
            };

            useEffect(() => {
                let html5QrCode;
                if (isScanning) {
                    const init = async () => {
                        await new Promise(r => setTimeout(r, 500));
                        if (!document.getElementById("reader")) {
                            console.error("Reader element not found");
                            setIsScanning(false);
                            return;
                        }
                        try {
                            html5QrCode = new Html5Qrcode("reader");
                            html5QrCodeRef.current = html5QrCode;
                            await html5QrCode.start(
                                { facingMode: "environment" }, 
                                { fps: 10, qrbox: { width: 250, height: 250 } }, 
                                (decodedText) => {
                                    setScanQuery(decodedText);
                                    stopScanner();
                                    handleScanLogic(decodedText);
                                },
                                (errorMessage) => { }
                            );
                        } catch (err) {
                            console.error("Camera start error:", err);
                            setIsScanning(false);
                            let msg = "Gagal membuka kamera.";
                            if (err.name === "NotAllowedError" || err.name === "PermissionDeniedError") {
                                msg = "Izin kamera ditolak. Silakan izinkan akses kamera di pengaturan browser Anda.";
                            } else if (err.name === "NotFoundError" || err.name === "DevicesNotFoundError") {
                                msg = "Kamera tidak ditemukan di perangkat ini.";
                            } else if (err.name === "NotReadableError" || err.name === "TrackStartError") {
                                msg = "Kamera sedang digunakan oleh aplikasi lain atau tidak dapat diakses.";
                            }
                            showAlert(msg, "Error Kamera", "danger");
                        }
                    };
                    init();
                }
                return () => {
                    if (html5QrCodeRef.current && html5QrCodeRef.current.isScanning) {
                        html5QrCodeRef.current.stop().then(() => {
                            html5QrCodeRef.current.clear();
                        }).catch(err => console.error("Stop failed", err));
                    }
                };
            }, [isScanning]);

            const handleScanLogic = (query) => {
                const q = query.toUpperCase().trim();
                const item = inventory.find(i=>i.sku===q || i.barcode===q || i.name.toUpperCase().includes(q));
                if(item) { setScanResult({type:'item', data:item}); } else {
                    const loc = locations.find(l=>l.code===q);
                    if(loc) { setScanResult({type:'location', data:loc, items: inventory.filter(i=>i.location===loc.code)}); } else { setScanResult({type:'not_found'}); }
                }
            };

            const handlePackingInput = (sku, field, value) => {
                const val = parseInt(value) || 0;
                setPackingInput(prev => ({ ...prev, [sku]: { ...prev[sku], [field]: val } }));
            };

            const savePackingData = async () => {
                const itemsToSave = Object.entries(packingInput).filter(([_, data]) => (data.single || 0) > 0 || (data.bundling || 0) > 0);
                if (itemsToSave.length === 0) return showAlert("Belum ada data packing yang diisi.", "Info");
                try {
                    const batch = db.batch();
                    const today = new Date().toISOString().split('T')[0];
                    const timestamp = Date.now();
                    itemsToSave.forEach(([sku, data]) => {
                        const item = inventory.find(i => i.sku === sku);
                        if (!item) return;
                        const docRef = db.collection(COLLECTION_PATH('packing_logs')).doc();
                        batch.set(docRef, {
                            date: today, itemId: item.id, itemName: item.name, sku: item.sku,
                            single: data.single || 0, bundling: data.bundling || 0,
                            total: (data.single || 0) + (data.bundling || 0),
                            user: currentUser.name, timestamp: timestamp
                        });
                    });
                    await batch.commit();
                    setPackingInput({});
                    showAlert("Laporan packing berhasil disimpan!", "Sukses", "success");
                } catch (error) { console.error(error); showAlert("Gagal menyimpan data: " + error.message, "Error", "danger"); }
            };

            const handleAddItem = async (e) => {
                e.preventDefault();
                if(inventory.some(i=>i.sku.toLowerCase()===newItem.sku.toLowerCase() && i.location === newItem.location)) return showAlert("Barang dengan SKU ini sudah ada di lokasi tersebut!", "Duplikat", "danger");
                try {
                    const itemData = { ...newItem, qty: parseInt(newItem.qty)||0, sku: newItem.sku.toUpperCase(), location: newItem.location.toUpperCase(), createdAt: Date.now() };
                    await db.collection(COLLECTION_PATH('inventory')).add(itemData);
                    if(itemData.qty > 0) {
                        await db.collection(COLLECTION_PATH('logs')).add({ type: 'in', itemName: itemData.name, sku: itemData.sku, qty: itemData.qty, date: getFormattedDate(Date.now()), user: currentUser.name, notes: 'Stok Awal', timestamp: Date.now() });
                    }
                    setNewItem({ name: '', sku: '', barcode: '', qty: 0, location: '' });
                    setModals(p=>({...p, add:false}));
                    showAlert("Data barang berhasil disimpan", "Sukses", "success");
                } catch(err) { if (err.code === 'permission-denied') handlePermissionError(); else showAlert(err.message, "Error", "danger"); }
            };

            const handleTransaction = async (type) => {
                if(!transaction.itemId || transaction.qty<=0) return showAlert("Data tidak valid", "Error", "warning");
                const itemRef = db.collection(COLLECTION_PATH('inventory')).doc(transaction.itemId);
                const qtyInt = parseInt(transaction.qty);
                try {
                    await db.runTransaction(async (t) => {
                        const doc = await t.get(itemRef);
                        if (!doc.exists) throw "Barang tidak ditemukan!";
                        const data = doc.data();
                        let newQty = data.qty || 0;
                        let newLoc = data.location;
                        if (type === 'out') {
                            if (newQty < qtyInt) throw "Stok tidak mencukupi!";
                            newQty -= qtyInt;
                        } else {
                            newQty += qtyInt;
                            if (transaction.targetLocation) newLoc = transaction.targetLocation;
                        }
                        t.update(itemRef, { qty: newQty, location: newLoc });
                    });
                    const item = inventory.find(i => i.id === transaction.itemId);
                    await db.collection(COLLECTION_PATH('logs')).add({
                        type, itemName: item?.name || 'Unknown', sku: item?.sku || 'Unknown', qty: qtyInt,
                        date: getFormattedDate(Date.now()), user: currentUser.name, 
                        notes: type==='in'? `${transaction.notes} -> ${transaction.targetLocation || item?.location}` : transaction.notes,
                        timestamp: Date.now()
                    });
                    setTransaction({itemId:'', qty:'', notes:'', targetLocation:''});
                    showAlert(`Stok berhasil di${type==='in'?'tambah':'kurangi'}`, "Transaksi Sukses", "success");
                } catch(err) { showAlert(typeof err === 'string' ? err : err.message, "Gagal", "danger"); }
            };

            const openMoveModal = (item) => {
                setMoveItem(item);
                setMoveSourceId(''); setMoveTargetLocation(''); setMoveQty('');
            };

            const handleMoveItemSubmit = async (e) => {
                e.preventDefault();
                if (!moveItem || !moveSourceId || !moveTargetLocation || !moveQty) return showAlert("Data tidak lengkap", "Error", "warning");
                const sourceItem = inventory.find(i => i.id === moveSourceId);
                if(!sourceItem) return showAlert("Data asal tidak ditemukan", "Error", "danger");
                if (sourceItem.location === moveTargetLocation) return showAlert("Lokasi tujuan sama dengan lokasi asal", "Info", "info");
                const qtyToMove = parseInt(moveQty);
                if(qtyToMove <= 0 || qtyToMove > sourceItem.qty) return showAlert("Jumlah tidak valid atau melebihi stok", "Error", "warning");

                try {
                    await db.runTransaction(async (t) => {
                        const sourceRef = db.collection(COLLECTION_PATH('inventory')).doc(moveSourceId);
                        const sourceDoc = await t.get(sourceRef);
                        if (!sourceDoc.exists) throw "Dokumen asal tidak ditemukan";
                        const newSourceQty = sourceDoc.data().qty - qtyToMove;
                        if(newSourceQty === 0) { t.delete(sourceRef); } else { t.update(sourceRef, { qty: newSourceQty }); }

                        const existingTargetItem = inventory.find(i => i.sku === sourceItem.sku && i.location === moveTargetLocation);
                        if(existingTargetItem) {
                            const targetRef = db.collection(COLLECTION_PATH('inventory')).doc(existingTargetItem.id);
                            const targetDoc = await t.get(targetRef);
                            if(targetDoc.exists) { t.update(targetRef, { qty: targetDoc.data().qty + qtyToMove }); } 
                            else { const newDocRef = db.collection(COLLECTION_PATH('inventory')).doc(); t.set(newDocRef, { ...sourceItem, qty: qtyToMove, location: moveTargetLocation, id: undefined }); }
                        } else {
                            const newDocRef = db.collection(COLLECTION_PATH('inventory')).doc();
                            const newItemData = { ...sourceItem, qty: qtyToMove, location: moveTargetLocation };
                            delete newItemData.id; t.set(newDocRef, newItemData);
                        }
                    });
                    await db.collection(COLLECTION_PATH('logs')).add({ type: 'move', itemName: sourceItem.name, sku: sourceItem.sku, qty: qtyToMove, date: getFormattedDate(Date.now()), user: currentUser.name, notes: `Pindah: ${sourceItem.location} -> ${moveTargetLocation}`, timestamp: Date.now() });
                    setMoveItem(null); setMoveSourceId(''); setMoveTargetLocation(''); setMoveQty('');
                    showAlert("Stok berhasil dipindahkan!", "Sukses", "success");
                } catch (err) { console.error(err); showAlert("Gagal memindahkan barang: " + err, "Error", "danger"); }
            };

            const deleteDoc = (collection, id, confirmMsg) => showConfirm(confirmMsg, async () => await db.collection(COLLECTION_PATH(collection)).doc(id).delete());

            const getFilteredLogs = () => {
                const now = new Date();
                let start = new Date(); let end = new Date();
                if (filterType === 'daily') { start.setHours(0,0,0,0); end.setHours(23,59,59,999); } 
                else if (filterType === 'weekly') { start.setDate(now.getDate() - 7); start.setHours(0,0,0,0); } 
                else if (filterType === 'monthly') { start.setDate(1); start.setHours(0,0,0,0); } 
                else if (filterType === 'custom' && customDateStart && customDateEnd) { start = new Date(customDateStart); start.setHours(0,0,0,0); end = new Date(customDateEnd); end.setHours(23,59,59,999); }
                return logs.filter(log => { const ts = log.timestamp; return ts >= start.getTime() && ts <= end.getTime(); }).sort((a,b) => b.timestamp - a.timestamp);
            };

            const downloadExcel = () => {
                const data = getFilteredLogs();
                if (data.length === 0) return showAlert("Tidak ada data", "Info");
                const headers = "Tanggal,Tipe,SKU,Nama Barang,Jumlah,User,Catatan\n";
                const rows = data.map(log => {
                    const cleanNotes = log.notes ? log.notes.replace(/,/g, ' ') : ''; 
                    const typeMap = { 'in': 'MASUK', 'out': 'KELUAR', 'move': 'PINDAH RAK' };
                    return `${log.date},${typeMap[log.type] || log.type},${log.sku},${log.itemName},${log.qty},${log.user},${cleanNotes}`;
                }).join("\n");
                const blob = new Blob([headers + rows], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url); link.setAttribute('download', `Laporan_${filterType}.csv`); document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            if (permissionError) return <PermissionErrorScreen />;

            if (!currentUser) {
                return (
                    <div className="min-h-screen flex flex-col items-center justify-center p-4 bg-slate-900 relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-b from-blue-900/20 to-slate-900 pointer-events-none"></div>
                        <div className="w-full max-w-sm bg-white p-8 rounded-3xl shadow-2xl animate-slide-up z-10">
                            <div className="text-center mb-8">
                                <div className="flex items-center justify-center mx-auto mb-4">
                                    <img src={LOGO_URL} alt="SNM Stock Logo" className="h-28 w-auto object-contain drop-shadow-md" onError={(e) => { e.target.onerror = null; e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                                    <h1 className="text-4xl font-extrabold text-blue-600 tracking-tight hidden">SNM Stock</h1>
                                </div>
                                <p className="text-slate-500 text-sm font-bold">Warehouse Management System</p>
                            </div>
                            {loginError && <div className="mb-4 p-3 bg-red-50 text-red-600 rounded-xl text-sm font-bold flex items-center gap-2 animate-fade-in"><AlertTriangle size={16}/> {loginError}</div>}
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Username</label><input type="text" className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 outline-none font-medium transition-colors" placeholder="admin" value={loginForm.username} onChange={e=>setLoginForm({...loginForm, username:e.target.value})} /></div>
                                <div><label className="text-[10px] font-bold text-slate-400 uppercase ml-1">Password</label><input type="password" className="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 outline-none font-medium transition-colors" placeholder="123" value={loginForm.password} onChange={e=>setLoginForm({...loginForm, password:e.target.value})} /></div>
                                <button disabled={loadingUsers} className="w-full bg-blue-600 text-white py-3.5 rounded-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all flex justify-center">{loadingUsers ? <Loader2 className="animate-spin"/> : 'Masuk'}</button>
                            </form>
                            <p className="text-center text-xs text-slate-400 mt-6">Pastikan internet lancar untuk memuat data.</p>
                        </div>
                    </div>
                );
            }

            const todayStart = new Date(); todayStart.setHours(0,0,0,0);
            const todayLogs = logs.filter(l => l.timestamp >= todayStart.getTime()).sort((a,b) => b.timestamp - a.timestamp);
            const filteredReportLogs = getFilteredLogs();
            const todayPackingLogs = packingLogs.filter(l => l.timestamp >= todayStart.getTime()).sort((a,b) => b.timestamp - a.timestamp);
            const totalPackedSingle = todayPackingLogs.reduce((a,b) => a + (b.single || 0), 0);
            const totalPackedBundle = todayPackingLogs.reduce((a,b) => a + (b.bundling || 0), 0);
            const availableSources = moveItem ? inventory.filter(i => i.sku === moveItem.sku) : [];
            const selectedSourceItem = availableSources.find(i => i.id === moveSourceId);

            return (
                <div className="flex h-screen bg-slate-50 overflow-hidden relative">
                    {/* AI Floating Button */}
                    <button 
                        onClick={() => setAiModalOpen(true)}
                        className="fixed bottom-20 right-4 z-30 bg-gradient-to-r from-indigo-600 to-violet-600 text-white p-4 rounded-full shadow-xl shadow-indigo-500/30 active:scale-95 transition-transform flex items-center gap-2 md:bottom-8 md:right-8"
                    >
                        <Sparkles size={24} className="animate-pulse"/>
                    </button>

                    <aside className={`fixed md:static inset-y-0 left-0 z-40 w-72 bg-white border-r border-slate-200 flex flex-col transition-transform duration-300 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 shadow-2xl md:shadow-none`}>
                        <div className="p-6 flex items-center justify-center border-b border-slate-50 shrink-0">
                             <img src={LOGO_URL} alt="Logo" className="h-16 w-auto object-contain" onError={(e) => { e.target.style.display = 'none'; e.target.nextSibling.style.display = 'block'; }} />
                             <h1 className="text-xl font-extrabold text-slate-800 hidden">SNM<span className="text-blue-600">Cloud</span></h1>
                        </div>
                        <nav className="flex-1 p-4 space-y-1 overflow-y-auto custom-scrollbar">
                            <SidebarLink tab="dashboard" icon={LayoutDashboard} label="Dashboard" />
                            <SidebarLink tab="inventory" icon={Box} label="Stok Barang Global" />
                            <SidebarLink tab="locations" icon={Warehouse} label="Lokasi & Rak" />
                            <div className="my-4 border-t border-slate-100"></div><p className="px-4 text-[10px] font-bold text-slate-400 uppercase mb-2">Operasional</p>
                            <SidebarLink tab="scanner" icon={ScanBarcode} label="Scanner" />
                            <SidebarLink tab="inbound" icon={ArrowDownCircle} label="Masuk" />
                            <SidebarLink tab="outbound" icon={ArrowUpCircle} label="Keluar" />
                            <SidebarLink tab="packing" icon={Archive} label="Packing (Logistik)" />
                            <div className="my-4 border-t border-slate-100"></div>
                            <SidebarLink tab="reports" icon={History} label="Laporan & History" />
                            {isAdmin && <SidebarLink tab="users" icon={Users} label="User Admin" />}
                        </nav>
                    </aside>
                    
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/20 z-30 md:hidden backdrop-blur-sm" onClick={()=>setIsSidebarOpen(false)}></div>}

                    <main className="flex-1 flex flex-col relative h-full overflow-hidden w-full">
                        <header className="h-14 glass-header flex items-center justify-between px-4 shrink-0 z-20">
                            <div className="flex items-center gap-3">
                                <button onClick={activeTab==='dashboard' ? ()=>setIsSidebarOpen(true) : ()=>navigateTo('dashboard')} className="md:hidden p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-lg">{activeTab==='dashboard' ? <Menu size={20}/> : <ChevronLeft size={20}/>}</button>
                                <h2 className="text-base font-extrabold text-slate-800 capitalize">{activeTab.replace('_', ' ')}</h2>
                            </div>
                            <div onClick={()=>{setProfileData({name: currentUser.name, username: currentUser.username, password: currentUser.password}); setModals(p=>({...p, profile:true}))}} className="flex items-center gap-2 cursor-pointer hover:bg-slate-100 p-1.5 rounded-xl transition-colors">
                                <div className="text-right hidden xs:block"><p className="text-xs font-bold text-slate-800">{currentUser.name}</p><p className="text-[10px] text-slate-400 capitalize">{currentUser.role}</p></div>
                                <div className="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold text-xs shadow-blue-500/30 shadow-lg">{currentUser.name.charAt(0)}</div>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto p-4 pb-24 md:pb-6 custom-scrollbar">
                            <div className="max-w-5xl mx-auto">
                                {activeTab === 'dashboard' && (
                                    <div className="space-y-5 animate-fade-in">
                                        {/* Banner AI */}
                                        <div onClick={() => { setAiModalOpen(true); handleAiAnalysis(); }} className="bg-gradient-to-r from-indigo-600 to-violet-600 rounded-2xl p-4 text-white shadow-lg shadow-indigo-200 cursor-pointer active:scale-95 transition-transform">
                                            <div className="flex items-center gap-3">
                                                <div className="bg-white/20 p-3 rounded-xl"><Sparkles size={24} /></div>
                                                <div>
                                                    <h3 className="font-bold text-lg">Analisa Stok Cerdas </h3>
                                                    <p className="text-xs text-white/80">Klik untuk minta AI menganalisis kesehatan gudang Anda sekarang.</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid gap-6 md:grid-cols-3">
                                            <div className="md:col-span-2 space-y-4">
                                                <h3 className="font-bold text-slate-800 flex items-center gap-2"><Warehouse size={18} className="text-blue-600"/> Stok per Lokasi</h3>
                                                {locations.map(loc => {
                                                    const locItems = inventory.filter(i => i.location === loc.code);
                                                    if(locItems.length === 0) return null;
                                                    return (
                                                        <div key={loc.id} className="bg-white rounded-2xl border border-slate-200 overflow-hidden shadow-sm">
                                                            <div className="bg-slate-50 px-4 py-3 border-b border-slate-200 flex justify-between items-center"><div><h4 className="font-bold text-slate-700 text-sm">{loc.name}</h4><p className="text-[10px] font-mono text-slate-400">KODE: {loc.code}</p></div><span className="text-xs font-bold bg-blue-100 text-blue-700 px-2 py-1 rounded-lg">{locItems.reduce((a,b)=>a+b.qty,0)} Unit</span></div>
                                                            <div className="divide-y divide-slate-50">{locItems.map(item => (<div key={item.id} className="px-4 py-3 flex justify-between items-center hover:bg-slate-50 transition-colors"><div><div className="font-bold text-slate-800 text-sm">{item.name}</div><div className="text-xs font-mono text-slate-400">{item.sku}</div></div><div className={`text-sm font-bold px-2.5 py-1 rounded-lg ${item.qty < 10 ? 'bg-red-50 text-red-600' : 'bg-emerald-50 text-emerald-600'}`}>{item.qty}</div></div>))}</div>
                                                        </div>
                                                    )
                                                })}
                                            </div>
                                            <div className="space-y-4">
                                                <h3 className="font-bold text-slate-800 flex items-center gap-2"><Activity size={18} className="text-orange-500"/> Transaksi Hari Ini</h3>
                                                <div className="bg-white rounded-2xl shadow-sm border border-slate-100 p-4 min-h-[200px]">
                                                    {todayLogs.length === 0 ? <div className="text-center py-8 text-slate-400"><div className="bg-slate-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-2"><Calendar size={20}/></div><p className="text-xs">Belum ada transaksi hari ini</p></div> : <div className="space-y-3">{todayLogs.map(log => (<div key={log.id} className="flex items-start gap-3 pb-3 border-b border-slate-50 last:border-0 last:pb-0"><div className={`p-1.5 rounded-lg mt-0.5 ${log.type==='in'?'bg-emerald-100 text-emerald-600': log.type==='out'?'bg-orange-100 text-orange-600':'bg-blue-100 text-blue-600'}`}>{log.type==='in'?<ArrowDownCircle size={14}/>: log.type==='out'?<ArrowUpCircle size={14}/>:<ArrowRightLeft size={14}/>}</div><div className="flex-1 min-w-0"><div className="flex justify-between items-start"><p className="font-bold text-slate-700 text-xs truncate">{log.itemName}</p><span className={`text-xs font-bold ml-2 ${log.type==='in'?'text-emerald-600': log.type==='out'?'text-orange-600':'text-blue-600'}`}>{log.type==='in'?'+': log.type==='out'?'-':''}{log.qty}</span></div><p className="text-[10px] text-slate-400 mt-0.5">{log.date.split(',')[1]}  {log.user}</p></div></div>))}</div>}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* PACKING MENU */}
                                {activeTab === 'packing' && (
                                    <div className="space-y-6 animate-fade-in">
                                        <div className="grid grid-cols-2 gap-3">
                                            <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><p className="text-xs font-bold text-slate-500 uppercase">Total Single Hari Ini</p><p className="text-2xl font-extrabold text-blue-600">{totalPackedSingle}</p></div>
                                            <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm"><p className="text-xs font-bold text-slate-500 uppercase">Total Bundle Hari Ini</p><p className="text-2xl font-extrabold text-purple-600">{totalPackedBundle}</p></div>
                                        </div>
                                        <div className="bg-white rounded-3xl border border-slate-200 shadow-sm overflow-hidden">
                                            <div className="bg-slate-800 p-4 text-white flex justify-between items-center"><h3 className="font-bold flex items-center gap-2"><ClipboardList size={18}/> Worksheet Packing</h3><p className="text-xs opacity-70 font-mono">{getFormattedDate(Date.now()).split(',')[0]}</p></div>
                                            <div className="p-4 space-y-3">
                                                <div className="relative mb-4"><Search className="absolute left-3 top-2.5 text-slate-400" size={18}/><input className="w-full pl-9 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:border-blue-500 outline-none text-sm" placeholder="Filter nama barang..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                                                <div className="space-y-3 max-h-[400px] overflow-y-auto custom-scrollbar pr-2">
                                                    {groupedInventory.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase())).map(item => {
                                                        const inputData = packingInput[item.sku] || { single: '', bundling: '' };
                                                        const total = (parseInt(inputData.single) || 0) + (parseInt(inputData.bundling) || 0);
                                                        return (
                                                            <div key={item.sku} className="border border-slate-100 rounded-xl p-3 hover:bg-slate-50 transition-colors">
                                                                <div className="flex justify-between items-start mb-2">
                                                                    <div>
                                                                        <p className="font-bold text-slate-800 text-sm">{item.name}</p>
                                                                        <p className="text-[10px] text-slate-400 font-mono">{item.sku}</p>
                                                                    </div>
                                                                    <div className="text-right">
                                                                         <span className="text-[10px] bg-slate-100 px-2 py-1 rounded-lg text-slate-500 font-bold">Stok: {item.totalQty}</span>
                                                                    </div>
                                                                </div>
                                                                <div className="grid grid-cols-3 gap-2 items-center">
                                                                    <div><label className="text-[8px] font-bold text-slate-400 uppercase block mb-1">Single</label><input type="number" min="0" className="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm text-center font-bold focus:border-blue-500 outline-none" placeholder="0" value={inputData.single} onChange={(e) => handlePackingInput(item.sku, 'single', e.target.value)}/></div>
                                                                    <div><label className="text-[8px] font-bold text-slate-400 uppercase block mb-1">Bundling</label><input type="number" min="0" className="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm text-center font-bold focus:border-purple-500 outline-none" placeholder="0" value={inputData.bundling} onChange={(e) => handlePackingInput(item.sku, 'bundling', e.target.value)}/></div>
                                                                    <div className="text-center bg-slate-100 rounded-lg py-1 h-full flex flex-col justify-center"><span className="text-[8px] font-bold text-slate-400 uppercase block">Total</span><span className="font-bold text-slate-700 text-sm">{total}</span></div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                                <div className="pt-2 border-t border-slate-100"><button onClick={savePackingData} className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:bg-blue-700 active:scale-95 transition-all"><Save size={18}/> Simpan Laporan Packing</button></div>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* GLOBAL INVENTORY VIEW */}
                                {activeTab === 'inventory' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex gap-2 sticky top-0 z-10 bg-slate-50 pb-2 pt-1">
                                            <div className="relative flex-1"><Search className="absolute left-3 top-2.5 text-slate-400" size={18}/><input className="w-full pl-9 pr-4 py-2 bg-white border border-slate-200 rounded-xl focus:border-blue-500 outline-none shadow-sm text-sm" placeholder="Cari barang / SKU..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} /></div>
                                            {isAdmin && <button onClick={()=>setModals(p=>({...p, add:true}))} className="bg-blue-600 text-white px-3 py-2 rounded-xl shadow-lg active:scale-95 transition-transform"><Plus size={20}/></button>}
                                        </div>
                                        <div className="space-y-2 pb-10">
                                            {loadingInv ? <div className="text-center p-10"><Loader2 className="animate-spin inline text-blue-500"/></div> :
                                            groupedInventory.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()) || i.sku.toLowerCase().includes(searchTerm.toLowerCase())).map(item => (
                                                <div key={item.sku} className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm active:bg-slate-50 transition-colors">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <div className="font-bold text-slate-800 text-base">{item.name}</div>
                                                            <span className="text-xs font-mono bg-slate-100 px-1.5 py-0.5 rounded text-slate-500 mt-1 inline-block">{item.sku}</span>
                                                        </div>
                                                        <div className="text-right">
                                                            <span className={`px-3 py-1 rounded-lg text-sm font-bold ${item.totalQty<10?'bg-red-50 text-red-600':'bg-green-50 text-green-600'}`}>{item.totalQty} Total</span>
                                                        </div>
                                                    </div>
                                                    
                                                    {/* Locations Chips */}
                                                    <div className="flex flex-wrap gap-2 mb-3">
                                                        {item.locations.map(loc => (
                                                            <span key={loc.id} className="bg-blue-50 text-blue-700 border border-blue-100 px-2 py-1 rounded-md text-[10px] font-bold flex items-center gap-1">
                                                                <MapPin size={10}/> {loc.code}: {loc.qty}
                                                            </span>
                                                        ))}
                                                    </div>

                                                    <div className="flex gap-2 justify-end border-t border-slate-50 pt-3">
                                                        <button onClick={()=>openMoveModal(item)} className="flex-1 bg-slate-800 text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center gap-2 hover:bg-slate-900">
                                                            <ArrowRightLeft size={14}/> Pindah / Transfer
                                                        </button>
                                                        {isAdmin && <button onClick={()=>deleteDoc('inventory', item.id, "Hapus barang ini?")} className="px-3 bg-red-50 text-red-500 rounded-lg hover:bg-red-100"><Trash2 size={16}/></button>}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* SCANNER */}
                                {activeTab === 'scanner' && (
                                    <div className="max-w-md mx-auto animate-fade-in">
                                        <div className="bg-slate-800 rounded-3xl p-6 text-center text-white shadow-xl relative overflow-hidden mb-4">
                                            <div className="absolute inset-0 bg-gradient-to-br from-blue-600 to-purple-600 opacity-20 pointer-events-none"></div>
                                            <div className="relative z-10">
                                                <h2 className="text-lg font-bold mb-1">Cek Stok Cepat</h2><p className="text-white/60 text-xs mb-4">Scan Barcode / Ketik SKU</p>
                                                {isScanning ? <div className="mb-4 relative bg-black rounded-2xl overflow-hidden border-2 border-white/20 animate-fade-in"><div id="reader" className="min-h-[250px] bg-black"></div><button onClick={stopScanner} className="absolute top-2 right-2 bg-red-600 text-white p-2 rounded-full z-10 shadow-lg"><X size={16}/></button></div> : <button onClick={startScanner} className="mb-4 w-full py-4 bg-white/10 hover:bg-white/20 border border-white/20 rounded-xl flex items-center justify-center gap-2 text-sm font-bold transition-colors active:bg-white/30"><Camera size={18}/> Buka Kamera</button>}
                                                <form onSubmit={(e)=>{e.preventDefault(); handleScanLogic(scanQuery)}} className="relative"><input type="text" className="w-full p-4 pl-10 bg-white/10 backdrop-blur border border-white/20 rounded-xl text-white placeholder-white/40 font-mono text-lg uppercase focus:bg-white/20 outline-none text-center" placeholder="KETIK SKU" value={scanQuery} onChange={e => setScanQuery(e.target.value)} /><Search className="absolute left-4 top-5 text-white/40" size={18}/></form>
                                            </div>
                                        </div>
                                        {scanResult && (
                                            <div className="bg-white rounded-2xl border border-slate-200 shadow-lg p-5 animate-slide-up">
                                                {scanResult.type === 'item' ? <div className="text-center"><h3 className="text-lg font-bold text-slate-800">{scanResult.data.name}</h3><p className="font-mono text-slate-400 text-sm mb-4">{scanResult.data.sku}</p><div className="grid grid-cols-2 gap-3"><div className="bg-slate-50 p-3 rounded-xl"><div className="text-[10px] text-slate-400 uppercase font-bold">Lokasi</div><div className="text-lg font-bold text-slate-800">{scanResult.data.location}</div></div><div className="bg-blue-50 p-3 rounded-xl"><div className="text-[10px] text-blue-400 uppercase font-bold">Stok</div><div className="text-lg font-bold text-blue-700">{scanResult.data.qty}</div></div></div></div> : scanResult.type === 'location' ? <div><div className="flex items-center gap-3 mb-3 pb-3 border-b border-slate-100"><div className="w-10 h-10 bg-purple-100 text-purple-600 rounded-lg flex items-center justify-center"><Warehouse size={20}/></div><div><h3 className="font-bold text-slate-800">{scanResult.data.name}</h3><p className="text-xs text-slate-500 font-mono">{scanResult.data.code}</p></div></div><div className="space-y-2">{scanResult.items.map(i=>(<div key={i.id} className="flex justify-between p-2 bg-slate-50 rounded-lg"><span className="text-slate-700 text-sm font-medium">{i.name}</span><span className="font-bold text-blue-600 text-sm">{i.qty}</span></div>))}</div></div> : <div className="text-center py-4 text-slate-400"><AlertTriangle size={24} className="mx-auto mb-1 opacity-50"/><p className="text-sm">Data tidak ditemukan</p></div>}
                                            </div>
                                        )}
                                    </div>
                                )}

                                {/* INBOUND/OUTBOUND */}
                                {['inbound', 'outbound'].includes(activeTab) && (
                                    <div className="max-w-lg mx-auto animate-fade-in">
                                        <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                                            <div className={`p-5 ${activeTab==='inbound'?'bg-emerald-600':'bg-orange-600'} text-white`}>
                                                <div className="flex items-center gap-3">
                                                    {activeTab==='inbound'?<ArrowDownCircle size={24}/>:<ArrowUpCircle size={24}/>}
                                                    <h2 className="text-lg font-bold">{activeTab==='inbound'?'Barang Masuk':'Barang Keluar'}</h2>
                                                </div>
                                            </div>
                                            <div className="p-5 space-y-4">
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Item Barang</label>
                                                    <select className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" value={transaction.itemId} onChange={e=>{const it=inventory.find(i=>i.id==e.target.value); setTransaction({...transaction, itemId:e.target.value, targetLocation:it?it.location:''})}}>
                                                        <option value="">-- Pilih Barang --</option>
                                                        {inventory.map(i=><option key={i.id} value={i.id}>{i.name} (Stok: {i.qty} @ {i.location})</option>)}
                                                    </select>
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Jumlah</label>
                                                        <input type="number" min="1" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none font-bold text-lg text-center" value={transaction.qty} onChange={e=>setTransaction({...transaction, qty:e.target.value})} />
                                                    </div>
                                                    <div>
                                                        <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Lokasi Rak</label>
                                                        {activeTab==='inbound' ? (
                                                            <select className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" value={transaction.targetLocation} onChange={e=>setTransaction({...transaction, targetLocation:e.target.value})}>
                                                                <option value="">-- Pilih --</option>
                                                                {locations.map(l=><option key={l.id} value={l.code}>{l.code}</option>)}
                                                            </select>
                                                        ) : <input disabled className="w-full p-3 bg-slate-100 text-slate-500 rounded-xl border border-slate-200 font-bold text-center text-sm" value={transaction.targetLocation||'-'} />}
                                                    </div>
                                                </div>
                                                <div>
                                                    <label className="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Catatan</label>
                                                    <input type="text" className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 outline-none text-sm" placeholder="Keterangan transaksi..." value={transaction.notes} onChange={e=>setTransaction({...transaction, notes:e.target.value})} />
                                                </div>
                                                <button onClick={()=>handleTransaction(activeTab==='inbound'?'in':'out')} className={`w-full py-3.5 rounded-xl text-white font-bold shadow-lg active:scale-95 transition-all ${activeTab==='inbound'?'bg-emerald-600 hover:bg-emerald-700':'bg-orange-600 hover:bg-orange-700'}`}>PROSES SIMPAN</button>
                                            </div>
                                        </div>
                                    </div>
                                )}

                                {/* LOCATIONS */}
                                {activeTab === 'locations' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex justify-between items-center">
                                            <h3 className="font-bold text-slate-800">Daftar Lokasi</h3>
                                            {isAdmin && <button onClick={()=>setModals(p=>({...p, loc:true}))} className="bg-slate-800 text-white px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1"><Plus size={14}/> Tambah</button>}
                                        </div>
                                        <div className="grid grid-cols-2 gap-3">
                                            {locations.map(loc => (
                                                <div key={loc.id} onClick={()=>{setSelectedLocation(loc)}} className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm active:border-blue-500 relative group cursor-pointer">
                                                    <div className="flex justify-between items-start mb-2">
                                                        <Warehouse size={20} className="text-slate-400"/>
                                                        <span className="font-mono text-[10px] font-bold bg-slate-100 px-1.5 py-0.5 rounded text-slate-500">{loc.code}</span>
                                                    </div>
                                                    <h4 className="font-bold text-slate-800 text-sm">{loc.name}</h4>
                                                    {isAdmin && <button onClick={(e)=>{e.stopPropagation(); deleteDoc('locations', loc.id, "Hapus lokasi ini?")}} className="absolute bottom-2 right-2 p-1.5 text-slate-300 hover:text-red-500"><Trash2 size={14}/></button>}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* REPORTS */}
                                {activeTab === 'reports' && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm">
                                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-3">
                                                <h3 className="font-bold text-slate-800 flex items-center gap-2"><History size={18} className="text-blue-600"/> Filter Laporan</h3>
                                                <button onClick={downloadExcel} className="bg-emerald-600 text-white px-3 py-2 rounded-xl text-xs font-bold flex items-center gap-2 shadow-emerald-200 shadow-lg hover:bg-emerald-700 transition-colors"><FileSpreadsheet size={16}/> Unduh Excel</button>
                                            </div>
                                            <div className="flex flex-wrap gap-2 mb-3">
                                                {['daily', 'weekly', 'monthly', 'custom'].map(t => (
                                                    <button key={t} onClick={()=>setFilterType(t)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-colors capitalize ${filterType===t ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500 border-slate-200 hover:bg-slate-50'}`}>
                                                        {t === 'daily' ? 'Hari Ini' : t === 'weekly' ? 'Minggu Ini' : t === 'monthly' ? 'Bulan Ini' : 'Custom'}
                                                    </button>
                                                ))}
                                            </div>
                                            {filterType === 'custom' && (
                                                <div className="grid grid-cols-2 gap-3 p-3 bg-slate-50 rounded-xl mb-2">
                                                    <div><label className="text-[10px] text-slate-400 font-bold uppercase">Dari</label><input type="date" className="w-full p-2 text-xs border rounded-lg" value={customDateStart} onChange={e=>setCustomDateStart(e.target.value)}/></div>
                                                    <div><label className="text-[10px] text-slate-400 font-bold uppercase">Sampai</label><input type="date" className="w-full p-2 text-xs border rounded-lg" value={customDateEnd} onChange={e=>setCustomDateEnd(e.target.value)}/></div>
                                                </div>
                                            )}
                                        </div>
                                        <div className="space-y-2 pb-10">
                                            {filteredReportLogs.length === 0 ? <div className="text-center py-10 text-slate-400"><p className="text-sm">Tidak ada data pada periode ini.</p></div> : filteredReportLogs.map(log => (
                                                <div key={log.id} className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center gap-3">
                                                    <div className={`p-2 rounded-lg shrink-0 ${log.type==='in'?'bg-emerald-50 text-emerald-600': log.type==='out'?'bg-orange-50 text-orange-600':'bg-blue-50 text-blue-600'}`}>
                                                        {log.type==='in'?<ArrowDownCircle size={18}/>: log.type==='out'?<ArrowUpCircle size={18}/>:<ArrowRightLeft size={18}/>}
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <div className="flex justify-between">
                                                            <p className="font-bold text-slate-700 text-sm truncate">{log.itemName}</p>
                                                            <span className={`text-xs font-bold ${log.type==='in'?'text-emerald-600': log.type==='out'?'text-orange-600':'text-blue-600'}`}>{log.type==='in'?'+': log.type==='out'?'-':''}{log.qty}</span>
                                                        </div>
                                                        <div className="flex justify-between mt-1">
                                                            <p className="text-[10px] text-slate-400">{log.date}  {log.user}</p>
                                                            <p className="text-[10px] text-slate-500 italic truncate max-w-[100px]">{log.notes}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* USERS */}
                                {activeTab === 'users' && isAdmin && (
                                    <div className="space-y-4 animate-fade-in">
                                        <div className="flex justify-between items-center">
                                            <h3 className="font-bold text-slate-800">Manajemen User</h3>
                                            <button onClick={()=>setModals(p=>({...p, users:true}))} className="bg-blue-600 text-white px-3 py-1.5 rounded-xl text-xs font-bold flex items-center gap-1"><UserPlus size={14}/> Tambah</button>
                                        </div>
                                        <div className="space-y-3">
                                            {users.map((user) => (
                                                <div key={user.id} className="bg-white rounded-xl border border-slate-200 p-4">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <p className="font-bold text-slate-800 text-sm">{user.name}</p>
                                                            <p className="text-xs text-slate-400">@{user.username}  <span className="capitalize">{user.role}</span></p>
                                                        </div>
                                                        {user.username!=='admin' && <button onClick={()=>deleteDoc('users', user.id, "Hapus user ini?")} className="text-slate-300 hover:text-red-500"><Trash2 size={16}/></button>}
                                                    </div>
                                                    <div className="bg-slate-50 p-3 rounded-lg text-xs space-y-2">
                                                        <div className="flex gap-2 items-center">
                                                            <p className="text-[10px] font-bold text-slate-400 w-16">RESET:</p>
                                                            <input className="flex-1 p-2 border border-slate-200 rounded-lg bg-white" placeholder="Password Baru" type="password" id={`pass-${user.id}`}/>
                                                            <button onClick={() => { const newPass = document.getElementById(`pass-${user.id}`).value; if(newPass) { db.collection(COLLECTION_PATH('users')).doc(user.id).update({password: newPass}); showAlert("Password berhasil direset", "Sukses", "success"); document.getElementById(`pass-${user.id}`).value = ''; } }} className="bg-slate-800 text-white px-3 py-2 rounded-lg font-bold">OK</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="md:hidden fixed bottom-0 inset-x-0 bg-white border-t border-slate-200 flex justify-between px-2 pb-safe z-50">
                            <BottomNavItem icon={Home} label="Home" active={activeTab==='dashboard'} onClick={()=>navigateTo('dashboard')}/>
                            <BottomNavItem icon={Package} label="Stok" active={activeTab==='inventory'} onClick={()=>navigateTo('inventory')}/>
                            <div className="relative -top-5"><button onClick={()=>navigateTo('scanner')} className="bg-blue-600 text-white p-4 rounded-full shadow-lg active:scale-95 transition-transform ring-4 ring-slate-50"><ScanBarcode size={24}/></button></div>
                            <BottomNavItem icon={ArrowDownCircle} label="Masuk" active={activeTab==='inbound'} onClick={()=>navigateTo('inbound')}/>
                            <BottomNavItem icon={ArrowUpCircle} label="Keluar" active={activeTab==='outbound'} onClick={()=>navigateTo('outbound')}/>
                        </div>
                    </main>

                    {/* --- MODALS --- */}
                    <Modal isOpen={modals.alert.isOpen} title={modals.alert.title} type={modals.alert.type} onClose={closeAlert}><p className="text-slate-600 mb-6 text-sm">{modals.alert.message}</p><div className="flex justify-end"><button onClick={closeAlert} className="bg-slate-800 text-white px-5 py-2 rounded-xl font-bold text-sm">OK</button></div></Modal>
                    <Modal isOpen={modals.confirm.isOpen} title="Konfirmasi" onClose={closeConfirm}><p className="text-slate-600 mb-6 text-sm">{modals.confirm.message}</p><div className="flex justify-end gap-3"><button onClick={closeConfirm} className="text-slate-500 px-4 py-2 rounded-xl font-bold text-sm">Batal</button><button onClick={() => { if(modals.confirm.onConfirm) modals.confirm.onConfirm(); closeConfirm(); }} className="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold text-sm">Ya</button></div></Modal>
                    <Modal isOpen={modals.add} title="Tambah Stok" onClose={()=>setModals(p=>({...p, add:false}))}><form onSubmit={handleAddItem} className="space-y-3"><div><label className="text-[10px] font-bold text-slate-400 uppercase">Nama Barang</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newItem.name} onChange={e=>setNewItem({...newItem, name:e.target.value})}/></div><div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] font-bold text-slate-400 uppercase">SKU / Kode</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newItem.sku} onChange={e=>setNewItem({...newItem, sku:e.target.value.toUpperCase()})}/></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Qty Awal</label><input type="number" min="0" className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newItem.qty} onChange={e=>setNewItem({...newItem, qty:e.target.value})}/></div></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Lokasi Rak</label><select required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newItem.location} onChange={e=>setNewItem({...newItem, location:e.target.value})}><option value="">Pilih Lokasi</option>{locations.map(l=><option key={l.id} value={l.code}>{l.code}</option>)}</select></div><button className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg text-sm mt-2">Simpan</button></form></Modal>
                    <Modal isOpen={modals.loc} title="Lokasi Baru" onClose={()=>setModals(p=>({...p, loc:false}))}><form onSubmit={async (e)=>{e.preventDefault(); if(locations.some(l=>l.code===newLocation.code)) return showAlert("Kode Lokasi sudah ada!", "Error"); await db.collection(COLLECTION_PATH('locations')).add(newLocation); setNewLocation({code:'', name:''}); setModals(p=>({...p, loc:false})); }} className="space-y-3"><div><label className="text-[10px] font-bold text-slate-400 uppercase">Kode Rak</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 uppercase text-sm" value={newLocation.code} onChange={e=>setNewLocation({...newLocation, code:e.target.value.toUpperCase()})}/></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Nama Area</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newLocation.name} onChange={e=>setNewLocation({...newLocation, name:e.target.value})}/></div><button className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg text-sm mt-2">Simpan</button></form></Modal>
                    <Modal isOpen={modals.users} title="User Baru" onClose={()=>setModals(p=>({...p, users:false}))}><form onSubmit={async (e) => { e.preventDefault(); if(users.some(u=>u.username === newUser.username)) return showAlert("Username dipakai", "Error", "warning"); await db.collection(COLLECTION_PATH('users')).add(newUser); setNewUser({ username: '', password: '', name: '', role: 'staff' }); setModals(p=>({...p, users: false})); }} className="space-y-3"><div><label className="text-[10px] font-bold text-slate-400 uppercase">Username</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newUser.username} onChange={e=>setNewUser({...newUser, username:e.target.value})}/></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Password</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newUser.password} onChange={e=>setNewUser({...newUser, password:e.target.value})}/></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Nama Lengkap</label><input required className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newUser.name} onChange={e=>setNewUser({...newUser, name:e.target.value})}/></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Role</label><select className="w-full p-2.5 bg-slate-50 rounded-xl border border-slate-200 text-sm" value={newUser.role} onChange={e=>setNewUser({...newUser, role:e.target.value})}><option value="staff">Staff Gudang</option><option value="admin">Admin</option></select></div><button className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg text-sm mt-2">Tambah User</button></form></Modal>
                    <Modal isOpen={modals.profile} title="Keamanan Akun" onClose={()=>setModals(p=>({...p, profile:false}))}><form onSubmit={async (e) => { e.preventDefault(); if (profileData.username !== currentUser.username && users.some(u => u.username.toLowerCase() === profileData.username.toLowerCase())) { return showAlert("Username sudah dipakai user lain.", "Gagal", "warning"); } await db.collection(COLLECTION_PATH('users')).doc(currentUser.id).update({ username: profileData.username, password: profileData.password }); setModals(p=>({...p, profile: false})); showAlert("Login (Username/Password) diperbarui", "Sukses", "success"); }} className="space-y-4"><div className="text-center mb-4"><div className="w-20 h-20 bg-blue-600 text-white rounded-full flex items-center justify-center text-2xl font-bold mx-auto shadow-lg mb-2">{profileData.name.charAt(0)}</div><div className="flex items-center justify-center gap-1 text-emerald-600 bg-emerald-50 w-fit mx-auto px-2 py-1 rounded-full"><ShieldCheck size={12} /><p className="text-[10px] font-bold uppercase tracking-wide">Akun Terverifikasi</p></div></div><div><label className="text-[10px] font-bold text-slate-400 uppercase flex justify-between">Nama Lengkap (PIC) <Lock size={12}/></label><input disabled className="w-full p-3 bg-slate-200 text-slate-500 rounded-xl border border-slate-200 text-sm font-bold cursor-not-allowed" value={profileData.name} /></div><div className="pt-2 space-y-4 border-t border-slate-100"><div><label className="text-[10px] font-bold text-slate-400 uppercase">Username Login</label><input required className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm focus:border-blue-500 outline-none transition-colors" value={profileData.username} onChange={e=>setProfileData({...profileData, username:e.target.value})}/></div><div><label className="text-[10px] font-bold text-slate-400 uppercase">Password Baru</label><input required className="w-full p-3 bg-slate-50 rounded-xl border border-slate-200 text-sm focus:border-blue-500 outline-none transition-colors" value={profileData.password} onChange={e=>setProfileData({...profileData, password:e.target.value})}/></div></div><div className="pt-4 flex flex-col gap-3"><button className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg text-sm active:scale-95 transition-transform">Simpan Perubahan</button><button type="button" onClick={() => setModals(p => ({...p, profile: false, confirm: { isOpen: true, message: "Keluar dari aplikasi?", onConfirm: () => { localStorage.removeItem('snm_active_user'); setCurrentUser(null); setIsSidebarOpen(false); }}}))} className="w-full bg-red-50 text-red-600 py-3 rounded-xl font-bold text-sm border border-red-100 flex items-center justify-center gap-2 hover:bg-red-100 transition-colors"><LogOut size={16}/> Keluar Aplikasi</button></div></form></Modal>
                    <Modal isOpen={!!selectedLocation} title={selectedLocation?.code} onClose={()=>setSelectedLocation(null)} type="info"><div className="space-y-3"><h5 className="font-bold text-slate-700 text-xs uppercase">Isi Rak: {selectedLocation?.name}</h5><div className="max-h-60 overflow-y-auto custom-scrollbar border rounded-xl border-slate-100">{inventory.filter(i=>i.location===selectedLocation?.code).length === 0 ? <p className="p-4 text-center text-slate-400 italic text-xs">Rak Kosong</p> : inventory.filter(i=>i.location===selectedLocation?.code).map(i=>(<div key={i.id} className="p-2.5 border-b border-slate-50 flex justify-between items-center last:border-0"><div><p className="font-bold text-slate-700 text-sm">{i.name}</p><p className="text-[10px] text-slate-400 font-mono">{i.sku}</p></div><div className="flex gap-2 items-center"><span className="font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded text-xs">{i.qty} Unit</span></div></div>))}</div></div></Modal>

                    <Modal isOpen={!!moveItem} title="Pindah / Transfer" onClose={()=>setMoveItem(null)}>
                        {moveItem && (
                            <form onSubmit={handleMoveItemSubmit} className="space-y-4">
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-100">
                                    <p className="text-xs text-slate-400 uppercase font-bold mb-1">Barang</p>
                                    <p className="font-bold text-slate-800">{moveItem.name}</p>
                                    <p className="text-xs text-slate-500 font-mono">{moveItem.sku}</p>
                                    <div className="mt-2 pt-2 border-t border-slate-200 text-[10px] text-slate-500">
                                        Total Global: {moveItem.totalQty} Unit
                                    </div>
                                </div>
                                
                                <div>
                                    <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Pilih Lokasi Awal (Sumber)</label>
                                    <select required className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm focus:border-blue-500 outline-none font-bold" value={moveSourceId} onChange={e=>{ setMoveSourceId(e.target.value); setMoveQty(''); }}>
                                        <option value="">-- Pilih Sumber --</option>
                                        {availableSources.map(s => (
                                            <option key={s.id} value={s.id}>{s.location} (Sisa: {s.qty})</option>
                                        ))}
                                    </select>
                                </div>

                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Ke Lokasi</label>
                                        <select required className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm focus:border-blue-500 outline-none font-bold" value={moveTargetLocation} onChange={e=>setMoveTargetLocation(e.target.value)}>
                                            <option value="">-- Pilih --</option>
                                            {locations.filter(l => l.code !== selectedSourceItem?.location).map(l => (
                                                <option key={l.id} value={l.code}>{l.code}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-slate-400 uppercase block mb-1">Jumlah</label>
                                        <input 
                                            type="number" 
                                            min="1" 
                                            max={selectedSourceItem?.qty} 
                                            className="w-full p-3 bg-white border border-slate-200 rounded-xl text-sm text-center font-bold focus:border-blue-500 outline-none" 
                                            placeholder="0" 
                                            value={moveQty} 
                                            onChange={e=>setMoveQty(e.target.value)} 
                                            disabled={!selectedSourceItem}
                                        />
                                        <p className="text-[9px] text-slate-400 text-right mt-1">
                                            {selectedSourceItem ? `Max: ${selectedSourceItem.qty}` : '-'}
                                        </p>
                                    </div>
                                </div>

                                <button className="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg text-sm flex items-center justify-center gap-2 active:scale-95 transition-transform">
                                    <ArrowRightLeft size={18}/> Proses Pindah
                                </button>
                            </form>
                        )}
                    </Modal>

                    {/* AI ASSISTANT MODAL */}
                    <Modal isOpen={aiModalOpen} title="Asisten Gudang Pintar" onClose={() => setAiModalOpen(false)} type="ai">
                        <div className="space-y-4 flex flex-col h-full">
                            {/* Header with Settings */}
                            <div className="flex justify-between items-center bg-indigo-50 p-2 rounded-lg border border-indigo-100">
                                <span className="text-xs font-bold text-indigo-800 flex items-center gap-1">
                                    <Sparkles size={14}/> Powered by Gemini AI
                                </span>
                                <button onClick={() => setShowKeyInput(!showKeyInput)} className="text-indigo-600 hover:bg-indigo-100 p-1 rounded transition-colors" title="Set API Key">
                                    <KeyRound size={16} />
                                </button>
                            </div>

                            {/* API Key Input Area */}
                            {showKeyInput && (
                                <div className="bg-white p-3 rounded-xl border border-orange-200 shadow-sm animate-slide-up">
                                    <p className="text-xs font-bold text-slate-600 mb-2">Konfigurasi API Key (Sinkronisasi Cloud)</p>
                                    <p className="text-[10px] text-slate-400 mb-2">API Key ini akan disimpan di Cloud dan aktif untuk semua perangkat.</p>
                                    <div className="flex gap-2">
                                        <input 
                                            type="password" 
                                            placeholder="Tempel API Key disini (AIza...)" 
                                            className="flex-1 p-2 text-xs border rounded-lg focus:border-indigo-500 outline-none"
                                            value={apiKeyInput}
                                            onChange={(e) => setApiKeyInput(e.target.value)}
                                        />
                                        <button onClick={saveApiKey} className="bg-indigo-600 text-white px-3 py-2 rounded-lg text-xs font-bold">Simpan</button>
                                    </div>
                                </div>
                            )}

                            {/* Mode Selection */}
                            <div className="flex gap-2 bg-slate-100 p-1 rounded-lg shrink-0">
                                <button onClick={() => setAiMode('analysis')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${aiMode === 'analysis' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>
                                    Analisa Cepat
                                </button>
                                <button onClick={() => setAiMode('chat')} className={`flex-1 py-2 text-xs font-bold rounded-md transition-all ${aiMode === 'chat' ? 'bg-white text-indigo-600 shadow-sm' : 'text-slate-500'}`}>
                                    Tanya Jawab
                                </button>
                            </div>

                            {/* Content Area */}
                            <div className="flex-1 overflow-y-auto min-h-[250px] bg-slate-50 rounded-xl border border-slate-100 p-4">
                                {aiLoading ? (
                                    <div className="flex flex-col items-center justify-center h-full text-indigo-400 gap-2">
                                        <Loader2 size={32} className="animate-spin" />
                                        <p className="text-xs animate-pulse">Sedang berpikir...</p>
                                    </div>
                                ) : aiResponse ? (
                                    <div className="prose prose-sm prose-indigo max-w-none">
                                        <div className="whitespace-pre-wrap text-sm text-slate-700 leading-relaxed">
                                            {aiResponse.split('\n').map((line, i) => {
                                                if (line.startsWith('- ') || line.startsWith('* ')) return <div key={i} className="flex gap-2 mb-1"><span className="text-indigo-500"></span><span>{line.substring(2)}</span></div>;
                                                if (line.startsWith('### ')) return <h4 key={i} className="font-bold text-indigo-700 mt-3 mb-1">{line.substring(4)}</h4>;
                                                if (line.startsWith('**')) return <p key={i} className="font-bold">{line.replace(/\*\*/g, '')}</p>;
                                                return <p key={i} className="mb-2">{line}</p>;
                                            })}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center justify-center h-full text-slate-400 text-center p-4">
                                        <Bot size={48} className="mb-2 opacity-20" />
                                        <p className="text-sm font-medium">
                                            {globalApiKey ? (aiMode === 'analysis' ? "Klik tombol di bawah untuk analisa stok otomatis." : "Tanyakan apa saja tentang stok gudang Anda.") : "API Key Belum Diatur. Klik ikon kunci di atas."}
                                        </p>
                                        {aiMode === 'chat' && (
                                            <div className="mt-4 text-xs space-y-2">
                                                <p className="bg-white px-3 py-1 rounded-full border cursor-pointer hover:border-indigo-300" onClick={()=>setAiQuery("Barang apa yang stoknya paling sedikit?")}>"Stok paling sedikit?"</p>
                                                <p className="bg-white px-3 py-1 rounded-full border cursor-pointer hover:border-indigo-300" onClick={()=>setAiQuery("Dimana lokasi barang Elektronik?")}>"Lokasi barang ...?"</p>
                                            </div>
                                        )}
                                    </div>
                                )}
                            </div>

                            {/* Footer Actions */}
                            <div className="shrink-0 pt-2">
                                {aiMode === 'analysis' ? (
                                    <button 
                                        onClick={handleAiAnalysis}
                                        disabled={!globalApiKey}
                                        className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 flex items-center justify-center gap-2 transition-all active:scale-95"
                                    >
                                        <Sparkles size={18} /> Mulai Analisa AI
                                    </button>
                                ) : (
                                    <form onSubmit={handleAiChat} className="flex gap-2">
                                        <input 
                                            type="text" 
                                            className="flex-1 p-3 bg-slate-100 border-0 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none"
                                            placeholder="Ketik pertanyaan..."
                                            value={aiQuery}
                                            onChange={(e) => setAiQuery(e.target.value)}
                                            disabled={!globalApiKey}
                                        />
                                        <button 
                                            type="submit"
                                            disabled={!aiQuery.trim() || aiLoading || !globalApiKey}
                                            className="bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white p-3 rounded-xl shadow-lg transition-all active:scale-95"
                                        >
                                            <Send size={20} />
                                        </button>
                                    </form>
                                )}
                            </div>
                        </div>
                    </Modal>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>